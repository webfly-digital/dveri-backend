this.BX=this.BX||{},this.BX.YandexMarket=this.BX.YandexMarket||{},this.BX.YandexMarket.Admin=this.BX.YandexMarket.Admin||{},function(t){"use strict";const e=window.YMarketJQuery||window.jQuery;class s{constructor(t,s,i,n={}){this._bindSearchPaste=!1,this.onCopyClick=()=>{this.copyClipboard(this.value()||this.parentValue())},this.onSelectOpen=()=>{this.handleSearchPaste(!0)},this.onSelectClosing=()=>{this.handleSearchPaste(!1)},this.onSearchPaste=t=>{const s=(t.originalEvent.clipboardData||window.clipboardData).getData("text/plain").toString(),i=s.split(/(\n\r|\n|\r)/gm).map((t=>t.trim())).filter((t=>""!==t));-1!==s.indexOf(" / ")||i.length<2||(t.target.value=i.join(" / "),t.preventDefault(),e(t.target).trigger("input"))},this.ajaxTransport=(t,e,s)=>{if(!/.+\/.+\[\d+]/.test(t.data.q))return this.transport.fetch("categories",{query:t.data.q,language:this.locale.language()}).then((t=>{e(this.prepareResults(t))})).catch((t=>{this._lastError=t.message,s()})),{};e(this.prepareResults([t.data.q]))},this.templateSelection=t=>""===t.id?t.text:t.id,this.$el=e(t),this.el=t,this.options=Object.assign({},this.constructor.defaults,n),this.transport=s,this.locale=i,this.bind(),this.bootSelect()}destroy(){this.unbind(),this.destroySelect()}bind(){this.handleSelectOpen(!0),this.handleSelectClose(!0),this.handleCopy(!0)}unbind(){this.handleSelectOpen(!1),this.handleSelectClose(!1),this.handleSearchPaste(!1),this.handleCopy(!1)}handleChange(t,e){this.selectElement()[t?"on":"off"]("change",e)}handleCopy(t){this.$el.find(this.options.copyElement)[t?"on":"off"]("click",this.onCopyClick)}handleSelectOpen(t){this.selectElement()[t?"on":"off"]("select2:open",this.onSelectOpen)}handleSelectClose(t){this.selectElement()[t?"on":"off"]("select2:closing",this.onSelectClosing)}handleSearchPaste(t){if(this._bindSearchPaste===t)return;e(".select2-search__field")[t?"on":"off"]("paste",this.onSearchPaste),this._bindSearchPaste=t}bootSelect(){this.selectElement().select2(Object.assign({},{width:"100%",minimumInputLength:2,selectOnClose:!0,allowClear:!0,ajax:{cache:!0,delay:1e3,transport:this.ajaxTransport},templateSelection:this.templateSelection},this.getLanguageOptions()))}destroySelect(){this.selectElement().select2("destroy")}getLanguageOptions(){return{placeholder:this.parentValue()||this.locale.message("CATEGORY_PLACEHOLDER"),language:Object.assign(this.languageDefaults(),{errorLoading:()=>{if(null!=this._lastError){const t=this._lastError;return this._lastError=null,t}return this.locale.message("CATEGORY_LOAD_ERROR")}})}}languageDefaults(){try{return e.fn.select2.amd.require(`select2/i18n/${this.locale.language()}`)}catch(t){return console.error(t),{}}}prepareResults(t){return{results:t.map((t=>({id:t,text:t})))}}copyClipboard(t){const s=e("<textarea></textarea>").css({position:"absolute",left:"-9999px",top:"-9999px"});s.insertAfter(this.$el),s.val(t),s[0].select(),this.execCommand("copy"),s.remove()}execCommand(t){try{return document.execCommand(t),!0}catch(t){return console.log(t),!1}}selectElement(){return this.$el.find(this.options.selectElement)}resetParent(t){const e=t||this.locale.message("CATEGORY_PLACEHOLDER");this.$el.find(this.options.parentElement).val(t||""),this.$el.find(".select2-selection__rendered").attr("title",e),this.$el.find(".select2-selection__placeholder").text(e)}parentValue(){return this.$el.find(this.options.parentElement).val()}value(){return this.selectElement().val()}}s.defaults={selectElement:"select",parentElement:'[data-entity="parentCategory"]',copyElement:'[data-entity="copy"]'};const i=window.BX;class n{constructor(t,e,s={}){this.onParameterWait=t=>{this.render(t,this.field.values())},this.onHintEnter=()=>{null==this._hintHover&&this.initialLoad().then((()=>{this.handleHintHover(!1),this._hintHover&&this._hint&&this._hint.Show()})),this._hintHover=!0},this.onHintLeave=()=>{this._hintHover=!1},this.el=t,this.field=e,this.options=Object.assign({},this.constructor.defaults,this.el.dataset,s),this.id=+(this.options.id||this.el.dataset.id)}destroy(){this.field.parametersRegistry.stopWait(this.id,this.onParameterWait),this.handleHintHover(!1),this.control.destroy(),this.control=null,this.options=null,this.el=null}initial(){this.handleHintHover(!0),this.control=this.initialControl(),this.field.parametersRegistry.wait(this.id,this.onParameterWait)}initialControl(){throw new Error("not implemented")}initialLoad(){return this.field.parametersRegistry.initialLoad()}render(t,e){this.handleHintHover(!1),this.setHint(t.description()),this.setRequired(t.required()),this.renderControl(t,e)}renderControl(t,e){if(null!=this.control){const s=this.control.el.name.replace(/\[]$/,""),i=this.control.value(),n=this.control.focused();return this.control.el.remove(),this.control.destroy(),this.control=this.parameterControl(t,s,e),this.control.setValue(i),void(n&&this.control.focus())}this.control=this.parameterControl(t,`${this.options.name}[VALUE]`,e)}parameterControl(t,e,s){throw new Error("not implemented")}handleHintHover(t){const e=this.el.querySelector(this.options.hintElement);e[t?"addEventListener":"removeEventListener"]("mouseenter",this.onHintEnter),e[t?"addEventListener":"removeEventListener"]("mouseleave",this.onHintLeave)}setHint(t){const e=this.el.querySelector(this.options.hintElement);if(!t)return this._hint&&this._hint.Destroy(),this._hint=null,void e.classList.add("is--hidden");null==this._hint?(e.classList.remove("is--hidden"),this._hint=new i.CHint({parent:e,hint:t,show_timeout:30})):this._hint.CONTENT?this._hint.setContent(t):this._hint.HINT=t}setRequired(t){this.el.classList[t?"add":"remove"]("is--required")}setValue(t){this.control.setValue(t)}value(){return this.control.value()}}n.defaults={id:null,hintElement:'[data-entity="hint"]',fieldElement:'[data-entity="field"]',valueElement:'[data-entity="value"]'};class l{constructor(t){this.el=t}destroy(){this.el=null}boot(){}value(){return this.el.value}setValue(t){this.el.value=null!=t?t:""}focused(){return document.activeElement===this.el}focus(){this.el.focus()}}var r;const a=null!=(r=window.YMarketJQuery)?r:window.$;class o extends l{constructor(t,e){super(t),this.$el=a(t),this.language=e}boot(){this.$el.select2({width:"100%",language:this.language,tags:this.allowedCustom()})}allowedCustom(){return{}}destroy(){this.$el.select2("destroy")}value(){if(!this.el.multiple)return this.el.value;const t=[];for(const e of this.el.querySelectorAll("option"))e.selected&&t.push(e.value);return t}setValue(t){const e=this._toArray(t),s=[];let i,n=!0,l=!1;for(const t of this.el.querySelectorAll("option")){if(n&&""===t.value){i=t;continue}const r=-1!==e.indexOf(t.value);r&&s.push(t.value),r!==t.selected&&(t.selected=r,l=!0),n=!1}if(this.allowedCustom())for(const t of e){if(-1!==s.indexOf(t))continue;const e=document.createElement("option");e.textContent=t,this.el.appendChild(e),e.selected=!0,s.push(t),l=!0}const r=0===s.length;null!=i&&i.selected!==r&&(i.selected=r,l=!0),l&&this.$el.triggerHandler("change.select2")}focus(){this.$el.select2("close"),this.$el.select2("open")}focused(){return this.$el.select2("isOpen")}_toArray(t){return null==t?[]:Array.isArray(t)?t:[t]}}class h extends o{destroy(){this.unbindFocus(),super.destroy()}bindFocus(t){this._focusCallback=t,this.$el.on("select2:opening",t)}unbindFocus(){null!=this._focusCallback&&(this.$el.off("select2:opening",this._focusCallback),this._focusCallback=null)}}function c(t,e){let s=t;if(null==e)return s;for(const[t,i]of Object.entries(e)){const e="#"+t+"#";let n=-1,l=-1;do{n=l,s=s.replace(e,i),l=s.indexOf(e)}while(-1!==l&&l>n)}return s}function u(t,e="div"){const s=document.createElement(e);return s.innerHTML=t,"table"===e?s.firstElementChild.firstElementChild:s.firstElementChild}class d extends l{static make(t,e){const s=t.maxLength();return new d(u(`<input\n\t\t \tclass="ym-category-parameter__control adm-input"\n\t\t\ttype="text"\n\t\t\tname="${e}"\n\t\t\t${null!=s?`maxlength="${s}"`:""}\n\t\t/>`))}}class m extends o{static make(t,e,s){const i=t.multiple(),n=u(`<select class="ym-category-parameter__control" name="${e}${i?"[]":""}" ${i?"multiple":""}>\n\t\t\t${i?"":'<option value="" disabled></option>'}\n\t\t</select>`);return new m(n,s,t)}constructor(t,e,s){super(t,e),this.parameter=s}destroy(){this.parameter=null,this.unbindChange(),super.destroy()}allowedCustom(){return this.parameter.allowCustom()}bindChange(t){this._changeCallback=t,this.$el.on("change",this._changeCallback)}unbindChange(){null!=this._changeCallback&&(this.$el.off("change",this._changeCallback),this._changeCallback=null)}reflow(t){const e=this._toArray(t[this.parameter.id()]),s=this.el.querySelectorAll("option"),i=s[0]&&s[0].disabled?s[0]:null,n=this.allowedCustom();let l=null!=i?1:0,r=[];for(const i of this._activeValues(t)){let t;for(;null!=s[l];){const a=s[l];if(null==a.dataset.id){if(n&&e.includes(a.value)){a.selected=!0,r.push(a.value),++l;continue}}else if(+a.dataset.id===i.id){t=a;break}a.remove(),++l}if(null==t){const e=s[l+1];t=document.createElement("option"),t.value=`${i.value} [${i.id}]`,t.textContent=i.value,t.dataset.id=i.id,e?this.el.insertBefore(t,e):this.el.appendChild(t)}const a=e.includes(t.value);t.selected=a,a&&r.push(t.value)}null!=i&&(i.selected=0===r.length)}_activeValues(t){const e=this.parameter.values(),s=this._restricted(t);if(null===s)return e;const i=[];for(const t of e)s.includes(t.id)&&i.push(t);return i}_restricted(t){const e=this.parameter.valueRestrictions();if(null==e)return null;let s=null;for(const i of e){const e=i.limitingParameterId;if(null==t[e])continue;const n=this._castOptionIds(t[e]);for(const t of i.limitedValues){if(!n.includes(t.limitingOptionValueId))continue;if(null==s){s=t.optionValueIds;continue}const e=[];for(const i of s)t.optionValueIds.includes(i)&&e.push(i);s=e}}return s}_castOptionIds(t){return null==t?[]:this._toArray(t).map((t=>{const e=/\[(\d+)]$/.exec(t);return e?+e[1]:null})).filter((t=>null!=t))}}class p extends o{static make(t,e,s){const i=u(`<select class="ym-category-parameter__control" name="${e}">\n\t\t\t<option value="Y">${s.message("BOOLEAN_Y")}</option>\n\t\t\t<option value="N">${s.message("BOOLEAN_N")}</option>\n\t\t</select>`);return new p(i,s.language())}}class f extends l{constructor(...t){super(...t),this._onInput=()=>{const t=parseFloat(this.el.value),e=!Number.isNaN(t)&&(null==this.el.min||t>=this.el.min)&&(null==this.el.max||t<=this.el.max);this._markInvalid(!e)},this._onChange=()=>{const t=parseFloat(this.el.value);isNaN(t)?this.el.value="":null!=this.el.min&&t<this.el.min?this.el.value=this.el.min:null!=this.el.max&&t>this.el.max&&(this.el.value=this.el.max),this._markInvalid(!1)}}static make(t,e){const s=t.minValue(),i=t.maxValue();return new f(u(`<input\n \t\t\tclass="ym-category-parameter__control adm-input" \n\t\t\ttype="number" \n\t\t\tname="${e}"\n\t\t\t${null!=s?`min="${s}"`:""}\n\t\t\t${null!=i?`max="${i}"`:""}\n\t\t/>`))}destroy(){this._handleInput(!1),super.destroy()}boot(){this._handleInput(!0)}_handleInput(t){this.el[t?"addEventListener":"removeEventListener"]("input",this._onInput),this.el[t?"addEventListener":"removeEventListener"]("change",this._onChange)}_markInvalid(t){this.el.classList[t?"add":"remove"]("is--invalid")}}class g extends n{static make(t,e,s){const i=t.defaultUnit(),n=u(`<tr class="ym-category-parameter">\n\t\t\t<td class="ym-category-parameter__title">\n\t\t\t\t<input type="hidden" name="${e}[ID]" value="${t.id()}" />\n\t\t\t\t<input type="hidden" name="${e}[NAME]" value="${t.name()}" />\n\t\t\t\t${null!=i?`<input type="hidden" name="${e}[UNIT]" value="${i.name} [${i.id}]" />`:""}\n\t\t\t\t<span class="ym-category-parameter__label">${t.name()}${null!=i?`, ${i.name}`:""}</span>\n\t\t\t\t<span class="ym-category-parameter__hint" data-entity="hint"></span>\n\t\t\t</td>\n\t\t\t<td class="ym-category-parameter__field" data-entity="field"></td>\n\t\t\t<td class="ym-category-parameter__actions">\n\t\t\t\t<button class="ym-category-parameter__delete" type="button" data-entity="delete">${s.locale.message("PARAMETER_DELETE")}</button>\n\t\t\t</td>\n        </tr>`,"table");return new g(n,s,{id:t.id(),name:e})}constructor(t,e,s={}){super(t,e,s),this.onChange=()=>{this.field.reflowDepended(this.id)},this.onDelete=()=>{this.field.delete(this)},this.handleDelete(!0)}destroy(){this.handleDelete(!1),super.destroy()}handleDelete(t){this.el.querySelector(this.options.deleteElement)[t?"addEventListener":"removeEventListener"]("click",this.onDelete)}initialControl(){const t=new h(this.el.querySelector(this.options.valueElement),this.field.locale.language());return t.boot(),t.bindFocus((()=>{this.initialLoad()})),t}reflow(t){this.control instanceof m&&this.control.reflow(t)}render(t,e){super.render(t,e),this.setDeprecated(!1)}parameterControl(t,e,s){const i=this.el.querySelector(this.options.fieldElement),n=class{static make(t,e,s){const i=t.type();return"ENUM"===i?m.make(t,e,s.language()):"BOOLEAN"===i?p.make(t,e,s):"NUMERIC"===i?f.make(t,e):d.make(t,e)}}.make(t,e,this.field.locale);return n instanceof m&&(n.reflow(s),n.bindChange(this.onChange)),i.appendChild(n.el),n.boot(),n}markDeprecated(){this.setDeprecated(!0),this.setRequired(!1),this.setHint(this.field.locale.message("PARAMETER_DEPRECATED"))}setDeprecated(t){this.el.classList[t?"add":"remove"]("is--deprecated")}}g.defaults=Object.assign({},n.defaults,{name:null,deleteElement:'[data-entity="delete"]'});const y=window.BX;class v{constructor(t,e,s){this._opening=!1,this.onClick=t=>{t.preventDefault(),this._opening||this.isOpen()||(this._opening=!0,this.field.parametersRegistry.collection().then((t=>{this._opening=!1,this.open(t)})).catch((t=>{this._opening=!1,this.field.state.error(t)})))},this.el=t,this.field=e,this.locale=s,this._menu=new y.CMenu({parent:this.el}),this.handleClick(!0)}destroy(){this._menu=null,this.handleClick(!1)}handleClick(t){this.el[t?"addEventListener":"removeEventListener"]("click",this.onClick)}isOpen(){return null!=this._menu&&"block"===(this._menu.DIV.style.display||"").toLowerCase()}open(t){0!==t.count()?(this._menu.setItems(this.menuItems(t)),this._menu.Show()):this.field.state.error(new Error(this.locale.message("EMPTY_PROPERTIES")))}select(t){this.field.add(t)}menuItems(t){const e=this.field.rows.map((t=>t.id)),s=this.field.rows.filter((t=>!!t.value())).map((t=>t.id)),i=this.availableParameters(t,e,s),n=[];for(const t of i)n.push({TEXT:`${t.name()}${t.required()?"*":""}`,HTML:`${t.name()}${t.required()?'<span class="ym-category-required-flag">*</span>':""}`,ONCLICK:()=>this.select(t)});return n}availableParameters(t,e,s){const i=[];for(const n of t.all())e.includes(n.id())||n.shownDependsOn(s)&&i.push(n);return i}}class _{constructor(t){this.fields=t}id(){return+this.fields.id}type(){return this.fields.type}multiple(){return!!this.fields.multivalue}required(){return!!this.fields.required}allowCustom(){return!!this.fields.allowCustomValues}description(){return this.fields.description}name(){return this.fields.name}values(){var t;return null!=(t=this.fields.values)?t:[]}maxLength(){var t;return null==(t=this.fields.constraints)?void 0:t.maxLength}minValue(){var t;return null==(t=this.fields.constraints)?void 0:t.minValue}maxValue(){var t;return null==(t=this.fields.constraints)?void 0:t.maxValue}valueRestrictions(){return this.fields.valueRestrictions}showByDefault(){return this.required()&&this.id()!==_.GROUP_ID}defaultUnit(){if(null==this.fields.unit)return null;for(const t of this.fields.unit.units)if(this.fields.unit.defaultUnitId===t.id)return t;return null}dependsOn(t){const e=this.valueRestrictions();if(null==e)return!1;for(const s of e)if(s.limitingParameterId===t)return!0;return!1}shownDependsOn(t){const e=this.valueRestrictions();if(null==e)return!0;for(const s of e)if(t.includes(s.limitingParameterId))return!0;return!1}}_.GROUP_ID=200;class w{constructor(t){this.collection=t.map((t=>new _(t)))}count(){return this.collection.length}all(){return this.collection}item(t){t=+t;for(const e of this.collection)if(e.id()===t)return e;return null}dependentOf(t){const e=[];for(const s of this.collection)s.dependsOn(t)&&e.push(s);return e}}class E{constructor(t,e,s){this._itemWaiting=[],this.category=t,this.transport=e,this.state=s}initialLoad(){return null!=this._parameters?Promise.resolve(this._parameters):this.fetch()}loaded(){return null!=this._parameters}reset(t){this._parameters=t,this.resolveWaiting(),this.resolveFetch()}collection(){return null!=this._parameters?Promise.resolve(this._parameters):this.fetch()}stopWait(t,e){for(const s of this._itemWaiting.keys()){const[i,n]=this._itemWaiting[s];if(i===t&&n===e){this._itemWaiting.splice(s,1);break}}}wait(t,e){null==this._parameters?this._itemWaiting.push([t,e]):this.resolveWaitingItem(t,e)}resolveWaiting(){for(const[t,e]of this._itemWaiting)this.resolveWaitingItem(t,e);this._itemWaiting=[]}resolveWaitingItem(t,e){const s=this._parameters.item(t);null!=s&&e(s)}item(t){return this.collection().then((e=>{const s=e.item(t);if(null==s)throw new Error("not found parameter {id}");return s}))}fetch(){return null!=this._parametersPromise||(this._parametersPromise=new Promise(((t,e)=>{this._parametersResolve=t,this.state.loading(),this.transport.fetch("parameters",{parentCategory:this.category.parentValue(),category:this.category.value()}).then((e=>{this._parametersResolve=null,this._parametersPromise=null,this.state.waiting(),this.reset(new w(e.parameters)),t(this._parameters)})).catch((t=>{this._parametersResolve=null,this._parametersPromise=null,this.state.error(t),e()}))}))),this._parametersPromise}resolveFetch(){null!=this._parametersResolve&&(this._parametersResolve(this._parameters),this._parametersResolve=null,this._parametersPromise=null)}}class C extends o{static make(t,e){const s=t.multiple();return new C(u(`<select class="ym-category-parameter__control" ${s?"multiple":""} disabled></select>`),e)}setValue(t){this.el.innerHTML="";for(const e of this._toArray(t)){const t=/^(.*)\s\[\d+]$/.exec(e),s=document.createElement("option");null!==t?(s.value=e,s.textContent=t[1]):s.textContent=e,s.selected=!0,this.el.appendChild(s)}}allowedCustom(){return!0}}class b extends n{static make(t,e){const s=t.defaultUnit(),i=u(`<tr class="ym-category-parameter">\n\t\t\t<td class="ym-category-parameter__title">\n\t\t\t\t<span class="ym-category-parameter__label">${t.name()}${null!=s?`, ${s.name}`:""}</span>\n\t\t\t\t<span class="ym-category-parameter__hint" data-entity="hint"></span>\n\t\t\t</td>\n\t\t\t<td class="ym-category-parameter__field" data-entity="field"></td>\n\t\t\t<td class="ym-category-parameter__actions"></td>\n        </tr>`,"table");return new b(i,e,{id:t.id()})}initialControl(){const t=new C(this.el.querySelector(this.options.valueElement),this.field.locale.language());return t.boot(),t}parameterControl(t,e,s){const i=this.el.querySelector(this.options.fieldElement),n=C.make(t,this.field.locale.language());return i.appendChild(n.el),n.boot(),n}}class O extends _{constructor(t,e,s){super({id:t,multivalue:e,title:s.message("UNKNOWN_PARAMETER",{ID:t})})}}class ${constructor(t,e,s,i,n={}){this.el=t,this.options=Object.assign({},this.constructor.defaults,n),this.state=s,this.locale=i,this.parametersRegistry=e,this.factoryMenu=new v(this.el.parentElement.querySelector(this.options.addElement),this,this.locale),this.bootRows()}destroy(){this.destroyRows(),this.factoryMenu.destroy()}reload(t,e,s){s?this.replaceParents(t):this.redrawParents(t,e),this.redrawParameters(t),this.redrawRequired(t),this.parametersRegistry.reset(t)}replaceParents(t){for(const e of this.rows.slice()){if(!(e instanceof b))continue;const s=t.item(e.id);if(null==s){this.delete(e);continue}const i=e.value(),n=this.rows.indexOf(e);this.delete(e);this.add(s,n+1).setValue(i)}}redrawParents(t,e){const s=[];for(const t of this.rows.slice())t instanceof b?null!=e[t.id]?(s.push(t.id),t.setValue(e[t.id])):this.delete(t):null!=e[t.id]&&this.delete(t);for(const[i,n]of Object.entries(e)){if(-1!==s.indexOf(+i))continue;const e=t.item(+i)||new O(+i,Array.isArray(n),this.locale);this.addParent(e,0).setValue(n)}}addParent(t){const e=this.el.tBodies[0]||this.el,s=b.make(t,this);return e.insertAdjacentElement("afterbegin",s.el),s.render(t,this.values()),this.rows.unshift(s),this.el.classList.remove("is--empty"),s}redrawParameters(t){for(const e of this.rows.slice()){if(!(e instanceof g))continue;const s=t.item(e.id);null!=s?e.render(s,this.values()):e.value()?e.markDeprecated():this.delete(e)}}redrawRequired(t){const e=this.rows.map((t=>t.id)),s=this.rows.filter((t=>!!t.value())).map((t=>t.id));for(const i of t.all())i.showByDefault()&&!e.includes(i.id())&&i.shownDependsOn(s)&&this.add(i)}add(t,e=null){const s=this.el.tBodies[0]||this.el,i=g.make(t,`${this.options.name}[${this.rowsIndex}]`,this);return null!=e&&null!=this.rows[e]?s.insertBefore(i.el,this.rows[e].el):(e=null,s.appendChild(i.el)),i.render(t,this.values()),null!=e?this.rows.splice(e,0,i):this.rows.push(i),++this.rowsIndex,this.el.classList.remove("is--empty"),i}reflowDepended(t){this.parametersRegistry.collection().then((e=>{for(const s of e.dependentOf(t)){const e=this.row(s.id());if(e instanceof g)e.reflow(this.values());else if(null==e&&s.showByDefault()){const e=this.row(t);if(null==e)continue;this.add(s,this.rows.indexOf(e)+1)}}}))}bootRows(){this.rows=[],this.rowsIndex=0;for(const t of this.el.querySelectorAll(this.options.parentRowElement)){const e=new b(t,this);e.initial(),this.rows.push(e)}for(const t of this.el.querySelectorAll(this.options.rowElement)){const e=new g(t,this);e.initial(),this.rows.push(e),++this.rowsIndex}}destroyRows(){for(const t of this.rows)t.destroy();this.rows=[]}delete(t){const e=this.rows.indexOf(t);if(-1===e)throw new Error("unknown item");const s=t.el;t.destroy(),s.remove(),this.rows.splice(e,1),0===this.rows.length&&this.el.classList.add("is--empty")}row(t){for(const e of this.rows)if(e.id===t)return e;return null}values(){const t={};for(const e of this.rows)t[e.id]=e.value();return t}}$.defaults={name:null,parentRowElement:'[data-entity="parentRow"]',rowElement:'[data-entity="parameterRow"]',addElement:'[data-entity="parametersFactory"]'};const k=window.BX;class x{constructor(t,e){this.options=Object.assign({},this.constructor.defaults,t),this.apiKeyField=e}fetch(t,e={}){return new Promise(((s,i)=>{const n={action:t,payload:e,componentParameters:this.options.componentParameters};null!=this.apiKeyField&&(n.apiKey=this.apiKeyField.value),k.ajax({url:this.options.url,method:"POST",dataType:"json",data:n,onsuccess:t=>{"ok"===t.status?s(t.data):"error"===t.status?i(new Error(t.message)):i(new Error("unknown response format"))},onfailure:t=>{i(new Error(t.message))}})}))}}x.defaults={url:null,componentParameters:{}};class L{constructor(t,e){this._messages=t,this._language=e}message(t,e=null){return c(this._messages[t]||"",e)}language(){return this._language}}var S;const R=null!=(S=window.YMarketJQuery)?S:window.$;class P{constructor(t,e={}){this.form=t,this.options=Object.assign({},this.constructor.defaults,e)}destroy(){this.form=null}handleChange(t,e){if(null!=e)for(const[,s]of Object.entries(this.options.fields))Array.isArray(s)?this.handleEvent(t,e,s[0],s[1],s[2]):this.handleEvent(t,e,s)}handleEvent(t,e,s,i,n){const l=this.form.querySelector(this.cssSelector(s));null!=l&&("onLookupInputChange"!==n?(null==n&&(n="change"),null==i?l[t?"addEventListener":"removeEventListener"](n,e):R(l)[t?"on":"off"](n,this.cssSelector(i),e)):window.jsUtils[t?"addCustomEvent":"removeCustomEvent"]("onLookupInputChange",this.onLookupInputChange.bind(this,e,l.id)))}onLookupInputChange(t,e,s,i){"add"===i.ACTION&&e===`layout_${i.CONTROL_ID}`&&t()}transportPayload(){return{type:this.options.type,payload:this.options.payload,fields:this.values()}}values(){const t={};for(const[e,s]of Object.entries(this.fields()))t[e]=this.value(s);return t}value(t){return t.multiple?Array.from(t.querySelectorAll("option")).filter((t=>t.selected)).map((t=>t.value)):t.value}fields(){if(!this.options.fields)return{};const t={};for(const[e,s]of Object.entries(this.options.fields)){const i=this.field(s);null!=i&&(t[e]=i)}return t}field(t){if(null===t||null==this.form)return null;if(Array.isArray(t)){const e=this.form.querySelector(this.cssSelector(t[0]));return null==e?null:e.querySelector(this.cssSelector(t[1]))}return this.form.querySelector(this.cssSelector(t))}apiKeyField(){return this.field(this.options.apiKeyField)}cssSelector(t){return/^(input|select|textarea|div|#|\.)/.test(t)?t:`[name="${t}"]`}}P.defaults={type:null,payload:{},fields:{},apiKeyField:null};class A{constructor(t,e,s={}){this.el=t,this.locale=e,this.options=Object.assign({},this.constructor.defaults,s)}loading(){this.state("loading",{LOADING:this.locale.message("LOADING")})}waiting(){this.state("waiting")}error(t){this.state("error",{MESSAGE:t.message})}state(t,e={}){const s=this.compileTemplate(t,e);this.markTypeClass(t),this.replaceHtml(s)}compileTemplate(t,e={}){return c(this.options[t+"Template"],e)}markTypeClass(t){const e=["loading","waiting","error"];for(const s of e)s===t?this.el.classList.add(`is--${s}`):this.el.classList.remove(`is--${s}`)}replaceHtml(t){this.el.innerHTML=t}}A.defaults={loadingTemplate:"#LOADING#...",waitingTemplate:"",errorTemplate:"#MESSAGE#"};class I{constructor(t,e={}){this.onCategoryChange=()=>{this.reload()},this.onFormChange=()=>{this.reloadDelayed()},this.el=t,this.options=Object.assign({},this.constructor.defaults,e),this.form=new P(this.el.closest("form"),this.formOptions()),this.locale=new L(this.options.locale,this.options.language),this.transport=new x(this.options.transport,this.form.apiKeyField()),this.state=new A(t.querySelector(this.options.stateElement),this.locale),this.category=new s(t.querySelector(this.options.categoryElement),this.transport,this.locale,this.options.category),this.paramaters=new $(t.querySelector(this.options.parametersElement),new E(this.category,this.transport,this.state),this.state,this.locale,this.parametersOptions(this.category)),this.category.handleChange(!0,this.onCategoryChange),this.form.handleChange(!0,this.onFormChange)}destroy(){clearTimeout(this._reloadTimeout),this.category.handleChange(!1,this.onCategoryChange),this.form.handleChange(!1,this.onFormChange),this.paramaters.destroy(),this.category.destroy(),this.form.destroy()}formOptions(){const t=Object.assign({},this.options.form);return null!=this.el.dataset.formPayload&&(t.payload=JSON.parse(this.el.dataset.formPayload)),t}parametersOptions(t){const e=Object.assign({},this.options.parameters);return null==e.name&&(e.name=t.selectElement().prop("name").replace(/\[CATEGORY]$/,"[PARAMETERS]")),e}reloadDelayed(){clearTimeout(this._reloadTimeout),window.JCIBlockGroupFieldIsRunning||(this._reloadTimeout=setTimeout((()=>this.reload()),200))}reload(){clearTimeout(this._reloadTimeout),this.state.loading(),this.transport.fetch("reload",{category:this.category.value(),form:this.form.transportPayload()}).then((t=>{this.category.resetParent(t.parentCategory),this.paramaters.reload(new w(t.parameters||[]),t.parentParameters,!!this.category.value()),this.state.waiting()})).catch((t=>{this.state.error(t)}))}}I.defaults={transport:null,language:"ru",locale:null,form:null,category:null,categoryElement:'[data-entity="category"]',parameters:null,parametersElement:'[data-entity="parameters"]',stateElement:'[data-entity="state"]'};const T=window.BX;class D{constructor(t,e={}){this.className=t,this.options=e,this.instances=[],this.boot(),this.bind()}boot(){for(const t of document.getElementsByClassName(this.className))t.classList.contains(D.READY_TOKEN)||(this.instances.push(new I(t,this.options)),t.classList.add(D.READY_TOKEN))}bind(){T.addCustomEvent("onAdminTabsChange",(()=>this.check())),T.addCustomEvent("Grid::updated",(()=>this.check())),T.addCustomEvent("Grid::noEditedRows",(()=>this.check()))}check(){for(const t of this.instances.slice())document.contains(t.el)||(t.destroy(),this.instances.splice(this.instances.indexOf(t),1))}}D.READY_TOKEN="ym-category--ready",t.CategoryFactory=D}(this.BX.YandexMarket.Admin.Property=this.BX.YandexMarket.Admin.Property||{});
//# sourceMappingURL=bundle.js.map
