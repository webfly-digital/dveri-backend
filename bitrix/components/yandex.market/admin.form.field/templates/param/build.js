this.BX=this.BX||{},this.BX.YandexMarket=this.BX.YandexMarket||{},this.BX.YandexMarket.Field=this.BX.YandexMarket.Field||{},function(e){"use strict";const t=window.YMarketJQuery||window.jQuery;window.BX;t.fn.select2.amd.define("select2/data/search",["./array","../utils","jquery"],(function(e,t){function i(e,t){this.searchVariants=t.get("data"),t.set("data",null),i.__super__.constructor.call(this,e,t)}return t.Extend(i,e),i.prototype.query=function(e,t){var i=[],n=this;(e.term||"").length>0&&("function"==typeof this.searchVariants&&(this.searchVariants=this.searchVariants()),this.searchVariants.forEach((function(t){var s=n.matches(e,t);null!==s&&i.push(s)}))),t({results:i})},i}));const i=window.YMarketJQuery||window.jQuery,n=window.BX,s=n.namespace("YandexMarket.Plugin"),l=n.namespace("YandexMarket.Field.Reference"),a=n.namespace("YandexMarket.Source"),o=n.namespace("YandexMarket.Utils");class r extends l.Base{initialize(){super.initialize(),this.bind(),this.initValueUi()}destroy(){this.unbind(),super.destroy()}bind(){this.handleSourceChange(!0),this.handleInputChange(!0),this.handleLinkedSourceFieldChange(!0)}unbind(){this.handleSourceChange(!1),this.handleInputChange(!1),this.handleLinkedSourceFieldChange(!1)}handleSourceChange(e){this.getElement("source")[e?"on":"off"]("change keyup",i.proxy(this.onSourceChange,this))}handleParentField(e,t){this.handleCopyTypeFieldChange(e,t),this.handleCopyTypeSelfFieldInput(t)}handleCopyTypeFieldChange(e,t){const n=this.options.copyType;if(null!=n){e.getTypeCollection(n)[t?"on":"off"]("change keyup",this.getElementSelector("field"),i.proxy(this.onCopyTypeFieldChange,this))}}handleCopyTypeSelfFieldInput(e){null!=this.options.copyType&&this.$el[e?"on":"off"]("input paste",this.getElementSelector("field"),i.proxy(this.onCopyTypeSelfFieldInput,this))}handleLinkedSourceFieldChange(e){null==this.options.linkedSources&&e||this.$el[e?"on":"off"]("change",this.getElementSelector("field"),i.proxy(this.onLinkedSourceFieldChange,this))}handleInputChange(e){const t=this.getElementSelector("input");this.$el[e?"on":"off"]("change",t,i.proxy(this.onInputChange,this))}onSourceChange(e){this.refreshField(e.target.value)}onCopyTypeFieldChange(e){const t=e.currentTarget;this.copyFieldValue(t)}onCopyTypeSelfFieldInput(e){const t=e.currentTarget;this._fieldValueUserInput=""!==t.value}onLinkedSourceFieldChange(e){const t=this.getElement("source").val();-1!==this.options.linkedSources.indexOf(t)&&this.$el.trigger("FieldParamNodeLinkedChange",{node:this,source:t,field:e.target.value})}onInputChange(){this.$el.trigger("FieldParamNodeChange")}preselect(){if("recommendation"!==this.getElement("source").val())return;const e=this.getElement("field"),t=e.find("option");if("select"===e.data("type"))for(let i=0;i<t.length;++i){let n=t[i];if(""!==n.value){n.selected||(n.selected=!0,e.trigger("change"));break}}}setValue(e){if(null!=e.TYPE){const t=this.getElement("source");t.val(e.TYPE),this.refreshField(t.val())}super.setValue(e),this.reflowFieldSelected(e)}syncLinked(e,t){this.syncLinkedSource(e)&&this.syncLinkedField(t)}syncLinkedSource(e){const t=this.getElement("source"),i=t.find("option");let n=!1;if(t.val()===e)return!0;for(let s=0;s<i.length;++s){let l=i[s];if(l.value===e){n=!0,l.selected||(l.selected=!0,t.trigger("change"));break}}return n}syncLinkedField(e){const t=this.getElement("field"),i=t.find("option"),n=e.replace(/\.[^.]+$/,".");let s=!1;if(""===n)return s;if("select"!==t.data("type"))return s;for(let e=0;e<i.length;++e){let l=i[e];if(0===l.value.indexOf(n)){s=!0,l.selected||(l.selected=!0,t.trigger("change"));break}}return s}clear(){super.clear(),this._fieldValueUserInput=!1}setParentField(e){const t=this.getParentField();null!=t&&this.handleParentField(t,!1),null!=e&&this.handleParentField(e,!0),super.setParentField(e)}isFieldValueUserInput(e){if(null==this._fieldValueUserInput){const t=(e||this.getElement("field")).val();this._fieldValueUserInput=null!=t&&""!==t}return this._fieldValueUserInput}copyFieldValue(e){const t=this.getElement("field"),n=(t.prop("tagName")||"").toLowerCase(),s=(e.tagName||"").toLowerCase();let l,a;"input"!==n||"select"!==s||this.isFieldValueUserInput(t)||(a=i("option",e).filter(":selected"),a.val()&&(l=a.text()),null!=l&&(l=l.replace(/^\[\d+]/,"").trim(),t.val(l)))}refreshField(e){if(null!=this._lastSource&&this._lastSource===e)return;const t=this.getManager(),i=t.getType(e);this._lastSource=e,this.updateField(i,t)}updateField(e,t){let i,n,s,l,a,r=this.getElement("field"),d=(r.data("type")||"").toLowerCase(),h=e.CONTROL||"select";if("select"===h&&(i=this.getFieldList(e.ID,t),s=r.val(),a="",null!=i&&i.length>0))for(this.options.required||(a+='<option value="">'+this.getLang("SELECT_PLACEHOLDER")+"</option>"),l=0;l<i.length;l++)n=i[l],n.DEPRECATED&&s!==n.ID||(a+='<option value="'+n.ID+'"'+(s===n.ID?" selected":"")+">"+o.escape(n.VALUE)+"</option>");d!==h&&(r=this.renderField(r,h)),null!=a&&r.html(a)}renderField(e,t){let n="field"+t.substring(0,1).toUpperCase()+t.substring(1),s=this.getTemplate(n),l=this.getElementSelector("field"),a=this.getElementSelector("input"),o=this.getElement("fieldWrap",e,"closest"),r=i(s),d=r.filter(l),h=d.add(r.find(a));return 0===o.length&&(o=e),0===d.length&&(d=r.find(l)),this.destroyValueUi(o),this.copyAttrList(e,h,["name","data-name"]),d.data("type",t),r.insertAfter(o),o.remove(),this.initValueUi(r),this._fieldValueUserInput=!1,d}destroyValueUi(e){let t=e||this.getElementFieldWrap();s.manager.destroyElement(t)}initValueUi(e){let t=e||this.getElementFieldWrap(),i=s.manager.initializeElement(t)[0];null!=i&&(i.setOptions({sourceManager:this.getManager(),sourceType:this.getElement("source").val(),nodeType:this.options.type}),"function"==typeof i.render&&i.render())}reflowFieldSelected(e){const t=this.getElementFieldWrap(),i=s.manager.getInstance(t);if(null!=i&&null!=i.setValue)return void i.setValue(this.sliceOnlyFieldValue(e));const n=this.getElementField();n.hasClass("select2-hidden-accessible")&&n.trigger("change.select2")}sliceOnlyFieldValue(e){if(null!=e.FIELD)return e.FIELD;const t={};for(const[i,n]of Object.entries(e)){const e=/^\[FIELD]\[(.*?)]/.exec(i);null!=e&&(t[e[1]]=n)}return t}getElementField(){return this.getElement("field")}getElementFieldWrap(){let e=this.getElement("fieldWrap");return e.length>0?e:this.getElementField()}copyAttrList(e,t,i){let n,s,l=this.readAttrList(e,i);for(n=t.length-1;n>=0;n--)s=t.eq(n),this.writeAttrList(s,l)}readAttrList(e,t){let i,n,s,l,a=e.data("complex"),o=a?"["+a+"]":null,r={};for(l=t.length-1;l>=0;l--)n=t[l],s=e.attr(n),null!=s&&(-1!==n.indexOf("name")&&(s=s.replace(/\[]$/,""),o&&(i=s.indexOf(o),-1!==i&&s.length===i+o.length&&(s=s.substring(0,i),"data-name"===n&&(s=s.replace(/^\[([^\]]+)]$/,"$1"))))),r[n]=s);return r}writeAttrList(e,t){let i,n,s=e.data("complex"),l=s?"["+s+"]":"";for(i in t)t.hasOwnProperty(i)&&(n=t[i],l&&-1!==i.indexOf("name")&&("data-name"===i&&0!==n.indexOf("[")?n="["+n+"]"+l:n+=l),e.attr(i,n))}getFieldList(e,t){let i;return t=t||this.getSourceManager(),i="recommendation"===e?t.getRecommendationList(this.options.type):t.getTypeFieldList(e,this.options.valueType,this.options.type),i}getManager(){if(null==this._manager){const e=this.getElement("manager",this.$el,"closest");this._manager=a.Manager.getInstance(e)}return this._manager}}r.dataName="FieldParamNode",r.defaults=Object.assign({},l.Base.prototype.defaults,{type:null,valueType:"string",required:!1,copyType:null,linkedSources:["iblock_property_feature"],managerElement:".js-param-manager",inputElement:".js-param-node__input",sourceElement:".js-param-node__source",fieldWrapElement:".js-param-node__field-wrap",fieldElement:".js-param-node__field",templateButtonElement:".js-param-node__template-button",fieldTextTemplate:'<input class="b-param-table__input js-param-node__input js-param-node__field" type="text" />',fieldFormulaTemplate:'<div class="b-input-formula js-param-node__field-wrap" data-plugin="Ui.Input.Formula"><select class="b-input-formula__function b-param-table__control js-param-node__input js-input-formula__function" data-complex="FUNCTION"></select><div class="b-input-formula__parts-wrap"><select class="b-input-formula__parts b-param-table__input js-param-node__field js-param-node__input js-input-formula__parts" data-complex="PARTS" size="1"></select></div><button class="b-input-formula__dropdown b-param-table__control adm-btn js-input-formula__dropdown" type="button">...</button></div>',fieldSelectTemplate:'<select class="b-param-table__input js-param-node__input js-param-node__field" data-plugin="Ui.Input.TagInput" data-width="100%" data-tags="false"></select>',fieldTemplateTemplate:'<div class="b-control-group js-param-node__field-wrap" data-plugin="Ui.Input.Template"><input class="b-control-group__item pos--first b-param-table__input js-param-node__input js-param-node__field js-input-template__origin" type="text" /><button class="b-control-group__item pos--last width--by-content adm-btn around--control js-input-template__dropdown" type="button">...</button></div>',langPrefix:"YANDEX_MARKET_FIELD_PARAM_",lang:{}});const d=window.YMarketJQuery||window.jQuery,h=top.BX,u=h.namespace("YandexMarket.Plugin");class c extends u.Base{constructor(...e){super(...e),this._valid=!1}initialize(){super.initialize(),this.bind()}destroy(){this.unbind(),super.destroy()}bind(){this.handleOpenClick(!0)}unbind(){this.handleOpenClick(!1)}handleOpenClick(e){this.$el[e?"on":"off"]("click",d.proxy(this.onOpenClick,this))}onOpenClick(e){const[t,i]=this.direct();null!=t?this.collection().addTag(t,i):this.open(),e.preventDefault()}direct(){const e=Object.entries(this.options.items);return 1!==e.length?[]:[e[0][0],null]}collection(){return this.options.collection}open(){if(null==this.el.OPENER)return this._valid=!0,void h.adminShowMenu(this.el,this.dropdownMenu(),{active_class:this.el.classList.contains("adm-btn")?"adm-btn-active":""});this._valid||this.el.OPENER.SetMenu(this.dropdownMenu())}dropdownMenu(){return this.dropdownItems(this.options.items)}dropdownItems(e,t=null){const i=[];for(const[n,s]of Object.entries(e))s.ENABLED&&i.push({TEXT:s.TITLE,HTML:s.TITLE,ONCLICK:()=>{this.collection().addTag(n,t)}});return i}showItem(e,t=null){this._valid=!1,this.toggleItem(e,t,!0),this.toggleVisible(!0)}hideItem(e,t=null){this.toggleItem(e,t,!1),this._valid=!1,!this.hasActiveItems()&&this.toggleVisible(!1)}toggleItem(e,t,i){this.options.items[e].ENABLED=i}hasActiveItems(){for(const[,e]of Object.entries(this.options.items))if(e.ENABLED)return!0;return!1}toggleVisible(e){this.$el.toggleClass("is--hidden",!e)}}c.defaults=Object.assign({},u.Base.prototype.defaults,{collection:null,items:{}});const p=window.BX.namespace("YandexMarket.Field.Reference");class g extends p.Complex{preselect(){this.getChildField("PARAM_VALUE").preselect()}enable(){const e=this.getChildField("SETTINGS");null!=e&&e.enable()}disable(){const e=this.getChildField("SETTINGS");null!=e&&e.disable()}}g.dataName="FieldParamTag",g.defaults=Object.assign({},p.Complex.prototype.defaults,{inputElement:".js-param-tag__input",childElement:".js-param-tag__child",lang:{},langPrefix:"YANDEX_MARKET_FIELD_PARAM_"});const m=window.YMarketJQuery||window.jQuery,f=window.BX.namespace("YandexMarket.Field.Reference");class _ extends f.Collection{initialize(){super.initialize(),this.initializeFactory(),this.bind()}destroy(){this.unbind(),this.destroyFactory(),super.destroy()}bind(){this.handleItemDeleteClick(!0)}unbind(){this.handleItemDeleteClick(!1)}handleItemDeleteClick(e){const t=this.getElementSelector("itemDelete");this.$el[e?"on":"off"]("click",t,m.proxy(this.onItemDeleteClick,this))}onItemDeleteClick(e){const t=m(e.currentTarget),i=this.getElement("item",t,"closest");this.deleteItem(i),e.preventDefault()}addTag(e){const t=this.getTypeCollection(e,!0),i=t.eq(-1),n=i.hasClass("is--hidden"),s=this.addItem(i);null!=s&&n&&1===t.length&&s.preselect()}addItem(e,t,i){const n=e||this.getElement("item").eq(-1),s=n.data("multiple"),l=n.data("required"),a=n.data("type");if(a){const e=this.getTypeCollection(a);if(!s&&e.length>0)return null;l&&1===e.length&&this.toggleItemDeleteView(!0,e),s||0!==e.length||null==this._factory||this._factory.hideItem(a,this._factoryIndex)}return this.toggleTitle(!0),super.addItem(n,t,i)}deleteItem(e){const t=e.data("required"),i=e.data("persistent"),n=e.data("type");if(n){const s=this.getTypeCollection(n);if((t||i)&&2===s.length)this.toggleItemDeleteView(!1,s);else{if(1===s.length)return void(t||i?this.clearItem(e):(null!=this._factory&&this._factory.showItem(n,this._factoryIndex),e.addClass("is--hidden"),this.destroyItem(e,!0),0===this.getActiveItems().length&&this.toggleTitle(!1)));if(0===s.length)return}}super.deleteItem(e)}toggleItemDeleteView(e,t){this.getElement("itemDelete",t).toggleClass("is--hidden",!e)}getTypeCollection(e,t){return this.getElement("item").filter((function(i,n){const s=m(n);return s.data("type")===e&&(t||!s.hasClass("is--hidden"))}))}toggleTitle(e){this.getElement("title").toggleClass("is--hidden",!e)}setFactory(e,t){this._factory=e,this._factoryIndex=t}initializeFactory(){const e=this.getElement("factory");0!==e.length&&(this._factory=new c(e,{collection:this}))}destroyFactory(){null!=this._factory&&null==this._factoryIndex&&(this._factory.destroy(),this._factory=null)}enable(){this.callItemList("enable")}disable(){this.callItemList("disable")}getItemPlugin(){return g}}_.dataName="FieldParamTagCollection",_.defaults=Object.assign({},f.Collection.prototype.defaults,{titleElement:".js-param-tag-collection__title",itemElement:".js-param-tag-collection__item",itemDeleteElement:".js-param-tag-collection__item-delete",factoryElement:".js-param-tag-collection__factory.level--0",factory:null});class y extends _{bind(){super.bind(),this.handleLinkedChange(!0)}unbind(){this.handleLinkedChange(!1),super.unbind()}handleLinkedChange(e){this.$el[e?"on":"off"]("FieldParamNodeLinkedChange",$.proxy(this.onLinkedChange,this))}onLinkedChange(e,t){this.callItemList((function(e){e!==t.node&&e.syncLinked(t.source,t.field)}))}toggleItemDeleteView(){}preselect(){this.callItemList("preselect")}getItemPlugin(){return r}}y.dataName="FieldParamNodeCollection",y.defaults=Object.assign({},_.defaults,{itemElement:".js-param-node-collection__item",itemDeleteElement:".js-param-node-collection__item-delete",factoryElement:".js-param-node-collection__attribute-factory"});class T extends c{direct(){if(this.options.groups.length>1)return[];const e=this.options.groups[0],t=super.direct(e.TAG_FACTORY);return null==t[0]?[]:[t[0],0]}dropdownMenu(){const e=[];for(let t=0;t<this.options.groups.length;++t){const i=this.options.groups[t],n=this.dropdownItems(i.TAG_FACTORY,t);0!==n.length&&(i.TITLE?this.options.groupFlat?e.push(...n.map((e=>(1===n.length?(e.TEXT=i.TITLE,e.HTML=i.TITLE):(e.TEXT=`${i.TITLE}: ${e.TEXT}`,e.HTML=`${i.TITLE}: ${e.HTML}`),e)))):e.push({TEXT:i.TITLE,HTML:i.TITLE,MENU:n}):e.push(...n))}return e}toggleItem(e,t,i){this.options.groups[t].TAG_FACTORY[e].ENABLED=i}hasActiveItems(){for(const e of this.options.groups)for(const[,t]of Object.entries(e.TAG_FACTORY))if(t.ENABLED)return!0;return!1}}T.defaults=Object.assign({},c.defaults,{groups:[],groupFlat:null});window.YMarketJQuery||window.jQuery;const E=window.BX.namespace("YandexMarket.Plugin");class C extends E.Base{initialize(){super.initialize(),this.initializeFactory(),this.initializeTagCollection()}destroy(){this.destroyTagCollection(),this.destroyFactory(),super.destroy()}initializeFactory(){this._factory=new T(this.getElement("add"),{collection:this})}destroyFactory(){null!=this._factory&&(this._factory.destroy(),this._factory=null)}initializeTagCollection(){const e=this.getElement("item");this._tagCollections=[];for(let t=0;t<e.length;++t){const i=_.getInstance(e[t]);i.setFactory(this._factory,t),this._tagCollections[t]=i}}destroyTagCollection(){if(null!=this._tagCollections){for(const e of this._tagCollections)e.destroy();this._tagCollections=null}}addTag(e,t){this._tagCollections[t].addTag(e)}factory(){return this._factory}enable(){for(const e of this._tagCollections)e.enable()}disable(){for(const e of this._tagCollections)e.disable()}}C.dataName="FieldParamTagCollectionGroup",C.defaults=Object.assign({},E.Base.prototype.defaults,{addElement:".js-param-tag-group__factory",itemElement:".js-param-tag-group__item"});class b{static push(e,t){null==this.groups[e]&&(this.groups[e]=[]),null==this.groupsMain[e]&&t.enabled()?(t.groupMain(),this.groupsMain[e]=t):(t.groupShadow(),null!=this.groupsMain[e]&&t.setValue(this.groupsMain[e].getValue())),this.groups[e].push(t)}static shift(e,t){if(null==this.groups[e])return;const i=this.groups[e],n=i.indexOf(t);-1!==n&&(i.splice(n,1),this.groupsMain[e]===t&&(t.destroyGroupMain(),this.groupsMain[e]=this._searchNewMain(e)))}static sync(e,t){if(null==this.groups[e])return;const i=t.getValue();for(const n of this.groups[e])n!==t&&n.setValue(i)}static enable(e,t){null==this.groupsMain[e]&&(t.groupMain(),this.groupsMain[e]=t)}static disable(e,t){this.groupsMain[e]===t&&(t.destroyGroupMain(),t.groupShadow(),this.groupsMain[e]=this._searchNewMain(e))}static _searchNewMain(e,t=null){for(const i of this.groups[e])if(i!==t&&i.enabled())return i.groupMain(),i;return null}}b.STATE_MAIN="main",b.STATE_SHADOW="shadow",b.groups={},b.groupsMain={};const F=window.BX.namespace("YandexMarket.Field.Reference");class I extends F.Complex{initialize(){super.initialize(),this.el.hasAttribute("data-disabled")?(this._enabled=!1,this.el.removeAttribute("data-disabled")):this._enabled=!0,this.pushRegistry()}destroy(){this.shiftRegistry(),super.destroy()}handleMainChange(e){this.$el[e?"on":"off"]("change",$.proxy(this.onMainChange,this))}onMainChange(){this.syncGroupDelayed()}clear(){this._groupState!==b.STATE_SHADOW&&super.clear()}pushRegistry(){null!=this.options.group&&b.push(this.options.group,this)}shiftRegistry(){null!=this.options.group&&b.shift(this.options.group,this)}groupMain(){this._groupState=b.STATE_MAIN,this.$el.removeClass("is--shadow"),this.handleMainChange(!0)}destroyGroupMain(){this._groupState=null,clearTimeout(this._syncGroupTimeout),this.handleMainChange(!1)}groupShadow(){this._groupState=b.STATE_SHADOW,this.$el.addClass("is--shadow")}syncGroupDelayed(){clearTimeout(this._syncGroupTimeout),this._syncGroupTimeout=setTimeout((()=>this.syncGroup()),100)}syncGroup(){b.sync(this.options.group,this)}enabled(){return this._enabled}enable(){null!=this.options.group&&(this._enabled=!0,b.enable(this.options.group,this))}disable(){null!=this.options.group&&(this._enabled=!1,b.disable(this.options.group,this))}}I.dataName="FieldParamSetting",I.defaults=Object.assign({},F.Complex.prototype.defaults,{inputElement:".js-param-tag-setting__input",childElement:".js-param-tag-setting__child",group:null,proxy:!0,name:"SETTING",lang:{},langPrefix:"YANDEX_MARKET_FIELD_PARAM_"});const w=window.BX.namespace("YandexMarket.Field.Reference");class M extends w.Complex{enable(){this.callChildList("enable")}disable(){this.callChildList("disable")}}M.dataName="FieldParamTagSettings",M.defaults=Object.assign({},w.Complex.prototype.defaults,{inputElement:".js-param-tag-settings__input",childElement:".js-param-tag-settings__child",lang:{},langPrefix:"YANDEX_MARKET_FIELD_PARAM_"}),e.Node=r,e.NodeCollection=y,e.Tag=g,e.TagSetting=I,e.TagSettings=M,e.TagCollection=_,e.TagGroup=C}(this.BX.YandexMarket.Field.Param=this.BX.YandexMarket.Field.Param||{});
//# sourceMappingURL=build.js.map
