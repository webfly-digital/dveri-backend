this.BX=this.BX||{},this.BX.YandexMarket=this.BX.YandexMarket||{},function(t){"use strict";const e=window.BX,n=window.jQuery,i=e.namespace("YandexMarket.Field.Reference").Complex.extend({defaults:{childElement:".js-yamarket-order__field",inputElement:".js-yamarket-order__input",areaElement:".js-yamarket-order__area",refreshUrl:null},initialize:function(){this.callParent("initialize",i),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",i)},bind:function(){this.handleActivityEnd(!0)},unbind:function(){this.handleActivityEnd(!1)},handleActivityEnd:function(t){e[t?"addCustomEvent":"removeCustomEvent"](this.el,"yamarketActivitySubmitEnd",e.proxy(this.onActivityEnd,this))},onActivityEnd:function(){this.refresh()},getId:function(){const t=this.getInput("ID");return t&&t.val()},confirm:function(){const t=this.getChildField("BOX"),e=this.getChildField("BASKET_CONFIRM");if(t&&e)return e.confirm(t)},validate:function(){this.callChildList("validate")},commit:function(){const t=this.getChildField("BOX");let e=!1,n=0;null!=t&&(t.callItemList((function(t){t.getBasket().commit(n)&&(e=!0),++n})),e&&this.refresh())},refresh:function(){n.ajax({url:this.options.refreshUrl}).then(n.proxy(this.updateArea,this)).then(n.proxy(this.hideLoading,this))},updateArea:function(t){const i=n(t),s=this.getElement("area",i),o=this.mapAreas(s),a=this.getElement("area"),l=this.mapAreas(a);for(const t in o){if(!o.hasOwnProperty(t))continue;if(!l.hasOwnProperty(t))continue;const n=o[t];l[t].replaceWith(n),e.onCustomEvent(n[0],"onYaMarketContentUpdate",[{target:n[0]}])}},mapAreas:function(t){const e={};for(let n=0;n<t.length;++n){const i=t.eq(n),s=i.data("type");s&&(e[s]=i)}return e},hideLoading:function(){e.closeWait(this.el)}},{dataName:"orderViewOrder",pluginName:"YandexMarket.OrderView.Order"}),s=i,o=window.BX,a=window.jQuery,l=o.namespace("YandexMarket.Field.Reference").Complex.extend({defaults:{selfElement:".js-yamarket-box",titleElement:".js-yamarket-box__title",numberElement:".js-yamarket-box__number",inputElement:".js-yamarket-box__input",childElement:".js-yamarket-box__child",deleteElement:".js-yamarket-box__delete",langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BOX_",lang:{}},initialize:function(){this.callParent("initialize",l),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",l)},bind:function(){this.handleDeleteClick(!0)},unbind:function(){this.handleDeleteClick(!1)},handleDeleteClick:function(t){this.getElement("delete")[t?"on":"off"]("click",a.proxy(this.onDeleteClick,this))},onDeleteClick:function(t){if(t.preventDefault(),this.onlyForPart()){if(!confirm(this.getLang("DELETE_PART_BY_MERGE")))return;this.getBasket().callItemList("cancelSplit")}else this.getCollection().deleteItem(this.$el)},onlyForPart:function(){let t=!1;return this.getBasket().callItemList((function(e){e.isPart()&&(t=!0)})),t},validate:function(){this.callChildList("validate")},getTitle:function(){const t=this.getElement("title");return t&&t.text().replace(/\s+/g," ").trim()},setIndex:function(t){this.callParent("setIndex",[t],l),this.updateNumber(t)},refreshDelete:function(t){this.getElement("delete").prop("disabled",!t)},refreshNumber:function(){const t=this.getIndex();this.updateNumber(t)},updateNumber:function(t){this.getElement("number").html("&numero;"+(t+1))},getBasket:function(){return this.getChildField("ITEMS")},getCollection:function(){return this.getParentField()},getElement:function(t,e,n){if("child"===t){const n=this.getElementSelector(t),i=this.getElementSelector("self");return(e||this.$el).nextUntil(i,n)}return this.callParent("getElement",[t,e,n],l)}},{dataName:"orderViewBox",pluginName:"YandexMarket.OrderView.Box"}),r=l,u=window.BX,h=u.namespace("YandexMarket.Field.Reference"),c=u.namespace("YandexMarket.Plugin"),d=h.Collection.extend({defaults:{itemElement:".js-yamarket-box",footerElement:"tfoot"},getCountChanges:function(){let t=[];return this.callItemList((function(e){t=t.concat(e.getBasket().getCountChanges())})),t},getPreviousMovableBox:function(t){let e,n;return this.callItemList((function(i){i===t&&(n=e),i.onlyForPart()||(e=i)})),n},getNextMovableBox:function(t){let e,n=!1;return this.callItemList((function(i){n&&null==e&&!i.onlyForPart()&&(e=i),i===t&&(n=!0)})),e},createNew:function(){return this.addItem()},sameBasketItems:function(t){let e=[];return this.callItemList((function(n){e=e.concat(n.getBasket().sameBasketItems(t))})),e},validate:function(){this.callItemList((function(t){try{t.validate()}catch(e){const n=t.getTitle(),i=(n?n+": ":"")+e.message;throw new Error(i)}}))},addItem:function(t,e,n,i){const s=this.callParent("addItem",[t,e,n,i],d);return this.refreshBoxNumber(),this.refreshBoxDelete(),s},detachItem:function(t){const e=this.getElementSelector("item"),n=this.getElementSelector("footer"),i=t.nextUntil([e,n].join(", "));this.callParent("detachItem",[t.add(i)],d)},cloneItem:function(t){const e=this.getElementSelector("item"),n=this.getElementSelector("footer"),i=t.nextUntil([e,n].join(", "));return t.clone(!1,!1).add(i.clone(!1,!1))},appendItem:function(t,e,n){if("after"===n){const t=this.getElementSelector("item"),i=this.getElementSelector("footer"),s=e.nextAll([t,i].join(", "));s.length>0?(e=s.eq(0),n="before"):(e=e.parent(),n="append")}e[n](t),c.manager.initializeContext(t)},deleteItem:function(t,e){this.transferBasket(t),this.callParent("deleteItem",[t,e],d),this.refreshBoxNumber(),this.refreshBoxDelete()},transferBasket:function(t){var e;const n=this.getItemInstance(t),i=n.getBasket();if(0===i.getActiveItems().length)return;const s=null!=(e=this.getPreviousMovableBox(n))?e:this.getNextMovableBox(n);if(null==s)throw new Error("cant delete last box");i.callItemList("move",[s])},initializeItem:function(t,e,n){return this.callParent("initializeItem",[t.eq(0),e,n],d)},refreshBoxNumber:function(){this.callItemList("refreshNumber")},refreshBoxDelete:function(){const t=this.getActiveItems().length>1;this.callItemList("refreshDelete",[t])},getOrder:function(){return this.getParentField()},getItemPlugin:function(){return r}},{dataName:"orderViewBoxCollection",pluginName:"YandexMarket.OrderView.BoxCollection"}),m=d,f=window.BX,g=window.jQuery,p=f.namespace("YandexMarket"),C=f.namespace("YandexMarket.Plugin").Base.extend({defaults:{modalWidth:400,modalHeight:150,lang:{}},initVars:function(){this.callParent("initVars",C),this._modal=null,this._openDeferred=null},handleModal:function(t,e){this.handleModalSave(t,e),this.handleModalClose(t,e)},handleModalSave:function(t,e){f[e?"addCustomEvent":"removeCustomEvent"](t,"onWindowSave",f.proxy(this.onModalSave,this))},handleModalClose:function(t,e){f[e?"addCustomEvent":"removeCustomEvent"](t,"onWindowClose",f.proxy(this.onModalClose,this))},onModalSave:function(){const t=this.modal();this.resolve(t),this.handleModal(t,!1),this.destroyModal(t),t.Close()},onModalClose:function(){const t=this.modal(!0);null!=t&&(this.reject(),this.handleModal(t,!1),this.destroyModal(t))},open:function(){const t=this.modal();return t.SetContent(this.$el.html()),t.Show(),this.afterOpen(t),this.handleModal(t,!0),this._openDeferred=new g.Deferred},afterOpen:function(t){},resolve:function(t){null!=this._openDeferred&&(this._openDeferred.resolve(this.resolveValues(t)),this._openDeferred=null)},reject:function(){null!=this._openDeferred&&(this._openDeferred.reject(),this._openDeferred=null)},resolveValues:function(t){return null},modal:function(t){return null!=this._modal||t||(this._modal=new p.EditDialog({title:this.getLang("TITLE"),draggable:!0,resizable:!0,buttons:[p.EditDialog.btnSave,p.EditDialog.btnCancel],width:this.options.modalWidth,height:this.options.modalHeight})),this._modal},modalContent:function(t){return g(t.PARTS.CONTENT_DATA)},destroyModal:function(){this._modal=null}}),I=C,E=window.jQuery,k=I.extend({defaults:{count:1,countElement:'input[name="MOVE_COUNT"]',boxElement:'select[name="MOVE_BOX"]',boxCollection:null,currentIndex:null,selectedIndex:null,langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_MOVE_",lang:{}},afterOpen:function(t){const e=this.modalContent(t);this.renderCount(e),this.renderBox(e)},renderCount:function(t){const e=this.getElement("count",t);e.val(this.options.count),e.prop("max",this.options.count)},renderBox:function(t){const e=this.getElement("box",t),n=this.options.boxCollection.getItemInstances();for(let t=0;t<n.length;t++){const i=n[t],s=i.getIndex()||0;if(s===this.options.currentIndex||i.onlyForPart())continue;const o=E(`<option value="${s+1}">${i.getTitle()}</option>`);o.prependTo(e),o.prop("selected",s===this.options.selectedIndex)}null==this.options.selectedIndex&&e.find("option").eq(-1).prop("selected",!0)},resolveValues:function(t){const e=this.modalContent(t);return[this.resolvedBox(e),this.resolvedCount(e)]},resolvedBox:function(t){const e=this.getElement("box",t),n=parseInt(e.val())||0;if(0===n)return this.options.boxCollection.createNew();const i=this.options.boxCollection.getItem(n-1);if(null==i)throw new Error(`cant find box with index ${n}`);return this.options.boxCollection.getItemInstance(i)},resolvedCount:function(t){const e=this.getElement("count",t);return parseInt(e.val())||1}}),_=I.extend({defaults:{countElement:'input[name="SPLIT_COUNT"]',langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_SPLIT_",lang:{}},resolveValues:function(t){const e=this.getElement("count",this.modalContent(t));return parseInt(e.val().trim())||1}}),y=window.BX,x=window.jQuery,T=y.namespace("YandexMarket.Field.Reference").Complex.extend({defaults:{id:null,childElement:".js-yamarket-basket-item__field",inputElement:".js-yamarket-basket-item__data",upElement:".js-yamarket-basket-item__up",moreElement:".js-yamarket-basket-item__more",downElement:".js-yamarket-basket-item__down",splitElement:".js-yamarket-basket-item__split",splitModalElement:"#yamarket-basket-split-modal",moveModalElement:"#yamarket-basket-move-modal",langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_",lang:{}},initVars:function(){this.callParent("initVars",T),this._moreDropdown=null},initialize:function(){this.callParent("initialize",T),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",T)},bind:function(){this.handleCountChange(!0),this.handleUp(!0),this.handleDown(!0),this.handleMore(!0)},unbind:function(){this.handleCountChange(!1),this.handleUp(!1),this.handleDown(!1),this.handleMore(!1)},handleCountChange:function(t){const e=this.getInput("COUNT");e&&e[t?"on":"off"]("change",x.proxy(this.onCountChange,this))},handleUp:function(t){this.getElement("up")[t?"on":"off"]("click",x.proxy(this.onUp,this))},handleDown:function(t){this.getElement("down")[t?"on":"off"]("click",x.proxy(this.onDown,this))},handleMore:function(t){this.getElement("more")[t?"on":"off"]("click",x.proxy(this.onMore,this))},onCountChange:function(){this.updateCisCount()},onUp:function(){const t=this.getBasket().getBox(),e=t.getCollection();this.moveStart(e,t,e.getPreviousMovableBox(t))},onDown:function(){const t=this.getBasket().getBox(),e=t.getCollection();this.moveStart(e,t,e.getNextMovableBox(t))},onMore:function(t){const e=this.moreDropdown(t.currentTarget);e.setItems(this.moreMenuItems()),e.Show()},id:function(){return this.getInput("ID").val()},moveStart:function(t,e,n){const i=this.getCount();if(i<=1){const e=this.move(null!=n?n:t.createNew());return e.recalculateOffset(),void e.getBasket().refreshItemMove()}new k(this.getElement("moveModal"),{count:i,currentIndex:e.getIndex(),selectedIndex:null!=n?n.getIndex():null,boxCollection:t}).open().then((t=>{const[e,n]=t;let s;n<i?(s=this.move(e,n,!0),this.setCount(this.getCount()-n),this.setInitialCount(this.getInitialCount()-n),this.recalculateOffset()):(s=this.move(e),s.recalculateOffset()),s.getBasket().refreshItemMove()}))},move:function(t,e,n){const i=t.getBasket().sameBasketItems(this),s=this.getBasket(),o=s.getBox();let a;return i.length>0?(a=i[0],null==e&&(e=this.getCount()),a.setCount(a.getCount()+e),a.setInitialCount(a.getInitialCount()+e),!n&&s.deleteItem(this.$el)):(a=t.getBasket().insertItem(n?this.$el.clone(!1,!1):this.$el),null!=e&&(a.setCount(e),a.setInitialCount(e))),0===s.getActiveItems().length?o.getCollection().deleteItem(o.$el):s.refreshItemMove(),a},moreDropdown:function(t){return null==this._moreDropdown&&(this._moreDropdown=new y.CMenu({ATTACH_MODE:"bottom",SET_ID:"bx-admin-prefix",CLOSE_ON_CLICK:!0,parent:t})),this._moreDropdown},moreMenuItems:function(){const t=this.getValue();return this.moreMenuItemsForSplit(t).concat(this.moreMenuItemsForDelete(t))},moreMenuItemsForDelete:function(t){if(null==t.DELETE||t.PARTIAL_CURRENT)return[];const e=[];return t.DELETE?e.push({ONCLICK:x.proxy(this.markDeleted,this,!1),TEXT:this.getLang("CANCEL_DELETE")}):e.push({ONCLICK:x.proxy(this.markDeleted,this,!0),TEXT:this.getLang("DELETE")}),e},moreMenuItemsForSplit:function(t){if(null==t.PARTIAL_CURRENT||t.DELETE)return[];const e=[];return t.PARTIAL_CURRENT?e.push({ONCLICK:x.proxy(this.cancelSplit,this),TEXT:this.getLang("CANCEL_SPLIT")}):e.push({ONCLICK:x.proxy(this.splitStart,this),TEXT:this.getLang("SPLIT")}),e},markDeleted:function(t){this.getInput("DELETE").val(t?"Y":""),this.$el.toggleClass("is--deleted",!!t)},cancelSplit:function(){const t=this.getBasket().getBox().getCollection().sameBasketItems(this),[e,n]=this.countSiblings(t);let i=!0;for(const o of t){if(i){var s;const t=o.getBasket().getBox(),a=null!=(s=t.getCollection().getPreviousMovableBox(t))?s:t.getCollection().getNextMovableBox(t);o.resetPart(),o.setCount(e),o.setInitialCount(n),o.setOffset(0),o.updateCisCount(),null!=a?o.move(a):o.getBasket().refreshItemMove(),i=!1;continue}const t=o.getBasket(),a=t.getBox();t.deleteItem(o.$el),0===t.getActiveItems().length&&a.getCollection().deleteItem(a.$el)}},countSiblings:function(t){let e=0,n=0;for(const i of t)i.isPart()&&!i.isFinalPart()||(e+=i.getCount()||0,n+=i.getInitialCount()||0);return[e,n]},splitStart:function(){new _(this.getElement("splitModal")).open().then((t=>this.split(t)))},split:function(t){var e;const n=this.getBasket().getBox().getCollection(),[i,s]=this.removeSiblings(),o=(this.getCount()||1)+i,a=(this.getInitialCount()||1)+s;let l;for(let e=0;e<o;++e)for(let i=0;i<t;++i){const s=0===e&&0===i,r=this.move(n.createNew(),1,!s);r.setPart(i,t),0===e&&r.setInitialCount(a-o+1),l=r}null==(e=l)||e.recalculateOffset()},removeSiblings(){const t=this.getBasket().getBox().getCollection().sameBasketItems(this);let e=0,n=0;for(const i of t){if(i===this)continue;const t=i.getBasket();if(e+=i.getCount()||0,n+=i.getInitialCount()||0,t.deleteItem(i.$el),0===t.getActiveItems().length){const e=t.getBox();e.getCollection().deleteItem(e.$el)}}return[e,n]},resetPart:function(){const t=this.getInput("PARTIAL_CURRENT"),e=this.getInput("PARTIAL_TOTAL"),n=this.getInput("PARTIAL_NAME");this.$el.removeClass("is--partial"),t.val(""),e.val(""),n.text("")},setPart:function(t,e){const n=this.getInput("PARTIAL_CURRENT"),i=this.getInput("PARTIAL_TOTAL"),s=this.getInput("PARTIAL_NAME");this.$el.addClass("is--partial"),n.val(t+1),i.val(e),s.text(`${this.getLang("PART")} ${t+1}/${e}`)},refreshMoveUp:function(t){this.getElement("up").prop("disabled",!t||this.isPart())},refreshMoveDown:function(t){!t&&this.getCount()>1&&(t=!0),this.getElement("down").prop("disabled",!t||this.isPart())},updateCisCount:function(){const t=this.getCount(),e=this.getOffset(),n=t>0,i=[this.getCis(),this.getDigital()];if(n)for(const n of i)null!=n&&(n.setBasketCount(t,e),n.refreshSummary())},isPart:function(){const t=this.getInput("PARTIAL_CURRENT");return t&&!!t.val()},isFinalPart:function(){const t=this.getInput("PARTIAL_CURRENT"),e=t&&parseInt(t.val())||0,n=this.getInput("PARTIAL_TOTAL"),i=n&&parseInt(n.val())||0;return e>0&&e===i},commit:function(t){const e=this.getCount(),n=this.getInitialCount(),i=this.getInput("INITIAL_BOX");let s=!1;return e!==n&&(s=!0,this.setInitialCount(e)),i&&i.val(t),s},getTitle:function(){const t=this.getInput("NAME");return t&&t.text()},getCountDiff:function(){let t;return t=this.needDelete()?this.getInitialCount():this.getInitialCount()-this.getCount(),t},setCount:function(t){this.getInput("COUNT").val(t)},getCount:function(){const t=this.getInput("COUNT");return null!==t?parseInt(t.val()):null},recalculateOffset:function(){const t=this.getBasket().getBox().getCollection().sameBasketItems(this);let e=0;for(const n of t)n.setOffset(e),n.isPart()&&!n.isFinalPart()||(e+=n.getInitialCount()),n.updateCisCount()},setOffset:function(t){this.getInput("OFFSET").val(t||0)},getOffset:function(){const t=this.getInput("OFFSET");return null!==t?parseInt(t.val()):null},getInitialCount:function(){const t=this.getInput("INITIAL_COUNT");return null!==t?parseInt(t.val()):null},setInitialCount:function(t){const e=this.getInput("COUNT"),n=this.getInput("INITIAL_COUNT");null==n||n.val(t),null==e||e.prop("max",t)},needDelete:function(){const t=this.getInput("DELETE");return t&&"Y"===t.val()},validate:function(){if(this.needDelete())return;const t=[this.getCis(),this.getDigital()];for(const e of t)e&&e.validate()},getCis:function(){return this.getChildField("IDENTIFIERS")},getDigital:function(){return this.getChildField("DIGITAL")},getBasket:function(){return this.getParentField()}},{dataName:"orderViewBasketItem",pluginName:"YandexMarket.OrderView.BasketItem"}),B=T,v=window.BX.namespace("YandexMarket.Field.Reference").Collection.extend({defaults:{itemElement:".js-yamarket-basket-item"},insertItem:function(t){return t.detach(),t.addClass("is--hidden"),t.appendTo(this.$el),this.addItem(t,null,null,!0)},sameBasketItems:function(t){const e=t.id(),n=[];return this.callItemList((t=>{t.id()===e&&n.push(t)})),n},addItem:function(t,e,n,i){const s=this.callParent("addItem",[t,e,n,i],v);return this.refreshItemMove(),s},deleteItem:function(t,e){this.callParent("deleteItem",[t,e],v),this.refreshItemMove()},refreshItemMove:function(){const t=this.getBox(),e=t.getCollection().getPreviousMovableBox(t),n=t.getCollection().getNextMovableBox(t),i=null!=e&&e.getBasket().getActiveItems().length>0,s=null!=n&&n.getBasket().getActiveItems().length>0,o=this.getActiveItems().length>1;this.callItemList("refreshMoveUp",[i]),this.callItemList("refreshMoveDown",[s||o])},validate:function(){this.callItemList((t=>{try{t.validate()}catch(e){const n=t.getTitle(),i=(n?n+": ":"")+e.message;throw new Error(i)}}))},commit:function(t){let e=!1,n=0;if(this.callItemList((i=>{if(i.getCount()<=0||i.needDelete())return e=!0,void this.deleteItem(i.$el);i.commit(t)&&(e=!0),++n})),0===n){const t=this.getBox();t.getCollection().deleteItem(t.$el)}return e},getCountChanges:function(){const t=[];return this.callItemList((e=>{let n=e.getCountDiff();n<=0||e.isPart()&&!e.isFinalPart()||t.push({name:e.getTitle(),diff:n})})),t},getItemPlugin:function(){return B},getBox:function(){return this.getParentField()}},{dataName:"orderViewBasket",pluginName:"YandexMarket.OrderView.Basket"}),w=v,M=window.BX.namespace("YandexMarket.Field.Reference").Base.extend({defaults:{inputElement:".js-yamarket-basket-item-cis__input",copyElement:".js-yamarket-basket-item-cis__copy",rowElement:".js-yamarket-basket-item-cis__row",copy:null,lang:{},langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_CIS_"},initialize:function(){this.callParent("initialize",M),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",M)},bind:function(){this.handleCopyClick(!0)},unbind:function(){this.handleCopyClick(!1)},handleCopyClick:function(t){this.getElement("copy")[t?"on":"off"]("click",$.proxy(this.onCopyClick,this))},onCopyClick:function(t){this.copy(),t.preventDefault()},copy:function(){const t=this.getCopyValue(),e=this.getValue();Object.assign(e,t),this.setValue(e)},getCopyValue:function(){const t=this.getParentField();let e;return null!=this.options.copy?e=this.options.copy:null!=t&&(e=t.getCopyValue()),e},setBasketCount:function(t,e){const n=this.getElement("row");for(let i=0;i<n.length;++i){const s=n.eq(i);i>=e&&i<e+t?(s.removeClass("is--hidden"),s.find("input").prop("disabled",!1)):(s.addClass("is--hidden"),s.find("input").prop("disabled",!0))}}},{dataName:"orderViewBasketItemCis",pluginName:"YandexMarket.OrderView.BasketItemCis"}),b=M,D=window.BX,S=window.jQuery,A=D.namespace("YandexMarket"),P=D.namespace("YandexMarket.Field.Reference").Summary.extend({defaults:{summaryElement:".js-yamarket-basket-item-cis__summary",fieldElement:".js-yamarket-basket-item-cis__field",modalElement:".js-yamarket-basket-item-cis__modal",modalWidth:400,modalHeight:300,requiredTypes:"",optionalTypes:"",copyElement:".js-yamarket-basket-item-cis__summary-copy",copy:null,lang:{},langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_CIS_"},initialize:function(){this.callParent("initialize",P),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",P)},bind:function(){this.handleSummaryClick(!0),this.handleCopyClick(!0)},unbind:function(){this.handleSummaryClick(!1),this.handleCopyClick(!1)},handleSummaryClick:function(t){this.getElement("summary")[t?"on":"off"]("click",S.proxy(this.onSummaryClick,this))},handleCopyClick:function(t){this.getElement("copy")[t?"on":"off"]("click",S.proxy(this.onCopyClick,this))},onSummaryClick:function(t){this.openEditModal(),t.preventDefault()},onCopyClick:function(t){this.copy(),this.refreshSummary(),t.preventDefault()},updateField:function(t){this.callParent("updateField",[t],P),this.syncSameBasketItems()},syncSameBasketItems:function(){const t=this.getBasketItem(),e=t.getBasket().getBox().getCollection().sameBasketItems(t);if(1===e.length)return;const n=this.$el.data("name"),i=this.getValue();for(const s of e){if(s===t)continue;const e=s.getChildField(n);null!=e&&(e.setValue(i),s.isPart()&&e.refreshSummary())}},validate:function(){const t=this.getValue();if("WAIT"===this.getCisStatus(t))throw new Error(this.getLang("REQUIRED"))},refreshSummary:function(){const t=this.getValue(),e=this.getCisStatus(t),n=this.getLang("SUMMARY_"+e)||e,i=this.getElement("summary");i.text(n),i.attr("data-status",e)},getCisStatus:function(t){const e=this.getBasketItem(),n=e.getCount(),[i,s]=this.getFilledCount(t,n,e.getOffset());let o;return o=i>=n?"READY":s>=n?"OPTIONAL":"WAIT",o},getFilledCount:function(t,e,n){const i=this.requiredTypes(),s=this.optionalTypes();let o=0,a=0;for(let r=n;r<n+e;++r){let e=0,n=0;for(const o of i){var l;""!==(null!=(l=t[`[ITEMS][${r}][${o}]`])?l:"").trim()?(++e,++n):-1!==s.indexOf(o)&&++n}e>=i.length&&++o,n>=i.length&&++a}return[o,a]},getBasketCount:function(){return this.getBasketItem().getCount()},setBasketCount:function(t,e){this.callField("setBasketCount",[t,e])},requiredTypes:function(){return(this.options.requiredTypes||"").split(",")},optionalTypes:function(){return(this.options.optionalTypes||"").split(",")},copy:function(){const t=this.getCopyValue(),e=this.getValue();Object.assign(e,t),this.setValue(e)},getCopyValue:function(){return this.options.copy},getFieldPlugin:function(){return b},getBasketItem:function(){return this.getParentField()},createModal:function(){return new A.EditDialog({title:this.options.title,draggable:!0,resizable:!0,buttons:[A.EditDialog.btnSave,A.EditDialog.btnCancel],width:this.options.modalWidth,height:this.options.modalHeight})}},{dataName:"orderViewBasketItemCisSummary",pluginName:"YandexMarket.OrderView.BasketItemCisSummary"}),O=P,N=window.BX.namespace("YandexMarket.Field.Reference").Base.extend({defaults:{inputElement:".js-yamarket-basket-item-digital__input",lang:{},langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_DIGITAL_"}},{dataName:"orderViewBasketItemDigital",pluginName:"YandexMarket.OrderView.BasketItemDigital"}),R=window.BX,L=window.jQuery,V=R.namespace("YandexMarket.Field.Reference").Summary.extend({defaults:{summaryElement:".js-yamarket-basket-item-digital__summary",fieldElement:".js-yamarket-basket-item-digital__field",modalElement:".js-yamarket-basket-item-digital__modal",modalWidth:450,modalBaseHeight:160,modalOneHeight:140,count:1,lang:{},langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_ITEM_DIGITAL_"},initVars:function(){this.callParent("initVars",V),this._basketCount=null},initialize:function(){this.callParent("initialize",V),this.bind()},destroy:function(){this.unbind(),this.callParent("destroy",V)},bind:function(){this.handleSummaryClick(!0)},unbind:function(){this.handleSummaryClick(!1)},handleSummaryClick:function(t){this.getElement("summary")[t?"on":"off"]("click",L.proxy(this.onSummaryClick,this))},onSummaryClick:function(t){this.resolveModalHeight(),this.openEditModal(),t.preventDefault()},resolveModalHeight:function(){this.options.modalHeight=this.options.modalBaseHeight+this.options.modalOneHeight*this.options.count},validate:function(){const t=this.getValue(),e=this.parseValue(t);if("WAIT"===this.getDigitalStatus(e))throw new Error(this.getLang("REQUIRED"))},refreshSummary:function(){const t=this.getValue(),e=this.parseValue(t),n=this.getDigitalStatus(e),i=this.getLang("SUMMARY_"+n)||n,s=this.getElement("summary");s.text(i),s.attr("data-status",n)},parseValue:function(t){const e={};for(const n in t){if(!t.hasOwnProperty(n))continue;const i=this.valueKeyChain(n);this.setValueByKeyChain(e,i,t[n])}return e},valueKeyChain:function(t){const e=t.split("["),n=[];for(const t of e){if(""===t&&0===n.length)continue;const e=t.replace(/]$/,"");n.push(e)}return n},setValueByKeyChain:function(t,e,n){const i=e.pop();let s=t;for(let t=0;t<e.length;++t){const n=e[t],o=t+1===e.length?i:e[t+1];null==s[n]&&(s[n]=/^\d+$/.test(o)?[]:{}),s=s[n]}s[i]=n},getDigitalStatus:function(t){let e;return e=this.getFilledCount(t)>=this.getBasketCount()?"READY":"WAIT",e},getFilledCount:function(t){let e=0;if(null==t.ITEM||!Array.isArray(t.ITEM))return e;for(const n of t.ITEM)""!==n.CODE&&""!==n.ACTIVATE_TILL&&++e;return e},getBasketCount:function(){return null!=this._basketCount?this._basketCount:this.options.count},setBasketCount:function(t){this._basketCount=t},getFieldPlugin:function(){return N}},{dataName:"orderViewBasketItemDigitalSummary",pluginName:"YandexMarket.OrderView.BasketItemDigitalSummary"}),F=V,j=window.BX.namespace("YandexMarket.Field.Reference").Base.extend({defaults:{inputElement:".js-yamarket-basket-confirm-form__input",productsElement:".js-yamarket-basket-confirm-form__products",langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_CONFIRM_",lang:{}},allowRemove:function(t){this.getInput("ALLOW_REMOVE").val(t?"Y":"")},setItemsChanges:function(t){const e=this.getElement("products"),n=this.compileItemsChanges(t);e.html(n)},compileItemsChanges:function(t){const e=[];for(const n of t)e.push(this.getLang("ITEM_CHANGE",{NAME:n.name,COUNT:n.diff}));return e.join("<hr />")}},{dataName:"orderViewBasketConfirmForm",pluginName:"YandexMarket.OrderView.BasketConfirmForm"}),Y=window.BX,X=window.jQuery,U=Y.namespace("YandexMarket.Field.Reference").Summary.extend({defaults:{modalElement:".js-yamarket-basket-confirm-summary__modal",fieldElement:".js-yamarket-basket-confirm-summary__field",modalWidth:500,modalHeight:350,langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_BASKET_CONFIRM_",lang:{}},initVars:function(){this.callParent("initVars",U),this._confirmDeferred=null},onEditModalSave:function(){this.callParent("onEditModalSave",U),this.allowRemove(!0),this.resolveConfirm()},onEditModalClose:function(){this.callParent("onEditModalClose",U),this.allowRemove(!1),this.rejectConfirm()},validate:function(){},confirm:function(t){const e=t.getCountChanges();if(0!==e.length)return this.setItemsChanges(e),this.initEdit(),this.waitConfirm();this.allowRemove(!1)},allowRemove:function(t){this.callField("allowRemove",[t])},setItemsChanges:function(t){this.callField("setItemsChanges",[t])},waitConfirm:function(){return this._confirmDeferred=new X.Deferred,this._confirmDeferred},resolveConfirm:function(){const t=this._confirmDeferred;null!==t&&(this._confirmDeferred=null,t.resolve())},rejectConfirm:function(){const t=this._confirmDeferred;null!==t&&(this._confirmDeferred=null,t.reject())},getFieldPlugin:function(){return j},getLang:function(t,e){return"MODAL_TITLE"===t&&null!=this.callField("getInput",["REASON"])&&(t="MODAL_TITLE_WITH_REASON"),this.callParent("getLang",[t,e],U)}},{dataName:"orderViewBasketConfirmSummary",pluginName:"YandexMarket.OrderView.BasketConfirmSummary"}),K=U,W=window.BX,z=window.jQuery,G=W.namespace("YandexMarket"),H=W.namespace("YandexMarket.Plugin").Base.extend({defaults:{url:null,width:400,height:300,items:[]},initialize:function(){this.callParent("initialize",H),this.bind()},destroy:function(){this.unbind(),this.callParent("initialize",H)},bind:function(){this.handleClick(!0),this.handleShipmentSubmit(!0)},unbind:function(){this.handleClick(!1),this.handleShipmentSubmit(!1)},handleClick:function(t){this.$el[t?"on":"off"]("click",z.proxy(this.onClick,this))},handleShipmentSubmit:function(t){t&&!this.isDisabled()||W[t?"addCustomEvent":"removeCustomEvent"]("yamarketShipmentSubmitEnd",W.proxy(this.onShipmentSubmitEnd,this))},onShipmentSubmitEnd:function(t){"ok"===t&&(this.enable(),this.handleShipmentSubmit(!1))},onClick:function(){this.createDropdown(),this.handleClick(!1)},isDisabled:function(){return this.$el.hasClass("is--hidden")},enable:function(){this.$el.removeClass("is--hidden")},createDropdown:function(){const t=this.getDropdownItems();W.adminShowMenu(this.el,t)},getDropdownItems:function(){const t=[],e=this.options.items;let n,i;for(n=0;n<e.length;n++)i=e[n],t.push({TEXT:i.TITLE,ACTION:this.openDialog.bind(this,i.TYPE)});return t},openDialog:function(t){const e=this.getItem(t),n=this.buildUrl(e);this.createDialog(n,e).Show()},createDialog:function(t,e){return new G.PrintDialog({title:e.DIALOG_TITLE||e.TITLE,content_url:t,width:e.WIDTH||this.options.width,height:e.HEIGHT||this.options.height,buttons:[G.PrintDialog.btnSave,G.PrintDialog.btnCancel]})},buildUrl:function(t){let e=this.options.url;return e+=(-1===e.indexOf("?")?"?":"&")+"type="+t.TYPE,e},getItem:function(t){const e=this.options.items;let n,i,s;for(i=0;i<e.length;i++)if(s=e[i],s.TYPE===t){n=s;break}return n}},{dataName:"orderViewShipmentPrint",pluginName:"YandexMarket.OrderView.ShipmentPrint"}),Q=H,q=window.BX,J=window.jQuery,Z=q.namespace("YandexMarket.Plugin"),tt=q.namespace("YandexMarket.Utils"),et=Z.Base.extend({defaults:{url:"yamarket_trading_shipment_submit.php",messageElement:".js-yamarket-shipment-submit__message",messageRowTemplate:'<div class="yamarket-shipment-submit__result-row" data-status="#STATUS#">#TEXT#</div>',orderElement:".js-yamarket-order",lang:{},langPrefix:"YANDEX_MARKET_T_TRADING_ORDER_VIEW_SHIPMENT_SUBMIT_"},initVars:function(){this.callParent("initVars",et),this._handleBoxCollectionChange=!1},destroy:function(){this.unbind(),this.callParent("initialize",et)},unbind:function(){this.handleShipmentChange(!1),this.handleBoxCollectionChange(!1)},handleShipmentChange:function(t){this.getOrderElement()[t?"on":"off"]("change",J.proxy(this.onOrderChange,this))},handleBoxCollectionChange:function(t){this._handleBoxCollectionChange!==t&&(this._handleBoxCollectionChange=t,q[t?"addCustomEvent":"removeCustomEvent"]("yamarketOrderViewBoxCollectionAddItem",q.proxy(this.onBoxCollectionModify,this)),q[t?"addCustomEvent":"removeCustomEvent"]("yamarketOrderViewBoxCollectionDeleteItem",q.proxy(this.onBoxCollectionModify,this)),q[t?"addCustomEvent":"removeCustomEvent"]("yamarketOrderViewBoxItemCollectionAddItem",q.proxy(this.onBoxCollectionModify,this)),q[t?"addCustomEvent":"removeCustomEvent"]("yamarketOrderViewBoxItemCollectionDeleteItem",q.proxy(this.onBoxCollectionModify,this)))},onOrderChange:function(){this.handleShipmentChange(!1),this.handleBoxCollectionChange(!1),this.clear()},onBoxCollectionModify:function(t){const e=this.getOrderElement();J.contains(e[0],t.el)&&(this.handleShipmentChange(!1),this.handleBoxCollectionChange(!1),this.clear())},clear:function(){this.showMessage("","")},activate:function(){this.el.disabled||this.validate()&&J.when(this.confirm()).then((()=>{this.el.disabled=!0,this.clear(),this.query().then(J.proxy(this.activateEnd,this),J.proxy(this.activateStop,this))}))},activateStop:function(t,e){const n=this.getLang("FAIL",{REASON:e});this.el.disabled=!1,this.showMessage(n,"error"),this.handleShipmentChange(!0),this.handleBoxCollectionChange(!0)},activateEnd:function(t){let e;this.el.disabled=!1,"object"!=typeof t||null==t.status?(e="error",this.showMessage(this.getLang("DATA_INVALID"),"error")):(e=t.status,null!=t.messages?this.showMessages(t.messages):this.showMessage(t.message,e)),"ok"===e&&this.commit(),this.handleShipmentChange(!0),this.handleBoxCollectionChange(!0),q.onCustomEvent(this.el,"yamarketShipmentSubmitEnd",[e])},validate:function(){let t,e=!0;try{this.getOrder().validate()}catch(n){t=this.getLang("VALIDATION_CONFIRM",{MESSAGE:n.message}),e=confirm(t||n.message)}return e},confirm:function(){return this.getOrder().confirm()},commit:function(){this.getOrder().commit()},query:function(){return J.ajax({url:this.options.url,type:"POST",data:this.getQueryData(),dataType:"json"})},getQueryData:function(){const t=this.getFormData();return t.push({name:"sessid",value:q.bitrix_sessid()}),t},showMessages:function(t){const e=this.getElement("message",this.$el,"siblings"),n=this.getTemplate("messageRow");let i="";for(let e of t)i+=tt.compileTemplate(n,{TEXT:e.text,STATUS:e.status});e.attr("data-status",""),e.html(i)},showMessage:function(t,e){const n=this.getElement("message",this.$el,"siblings");n.attr("data-status",e),n.html(t||"")},getFormData:function(){return this.getOrderElement().find("input, select, textarea").serializeArray()},getOrderElement:function(){return this.getElement("order",this.$el,"closest")},getOrder:function(){const t=this.getOrderElement();return Z.manager.getInstance(t)}},{dataName:"orderViewShipmentSubmit",pluginName:"YandexMarket.OrderView.ShipmentSubmit"}),nt=et;t.Order=s,t.BoxCollection=m,t.Box=r,t.Basket=w,t.BasketItem=B,t.BasketItemCisSummary=O,t.BasketItemCis=b,t.BasketItemDigitalSummary=F,t.BasketItemDigital=N,t.BasketConfirmSummary=K,t.BasketConfirmForm=j,t.BasketItemSplitModal=_,t.BasketItemMoveModal=k,t.ShipmentPrint=Q,t.ShipmentSubmit=nt}(this.BX.YandexMarket.OrderView=this.BX.YandexMarket.OrderView||{});
//# sourceMappingURL=script.js.map
