this.BX=this.BX||{},this.BX.YandexMarket=this.BX.YandexMarket||{},this.BX.YandexMarket.UI=this.BX.YandexMarket.UI||{},function(t){"use strict";const e=window.BX;class s{constructor(t={}){this.onEditorInit=(t,e)=>{e.methods[this.options.name]=this.build,this.handleEditorInit(!1)},this.build=(t,e,s)=>{const n=this.options.name+"_";if(0!==t.indexOf(n))return null;const i=t.substr(n.length);if(!this.options.map.hasOwnProperty(i))return null;return this.options.map[i].create(e,s)},this.options=Object.assign({},this.constructor.defaults,t)}register(){this.isEditorInitialized()?this.registerEditorMethod():this.handleEditorInit(!0)}isEditorInitialized(){var t,s;return null==(t=e.UI)||null==(s=t.EntityEditorControlFactory)?void 0:s.initialized}registerEditorMethod(){e.UI.EntityEditorControlFactory.registerFactoryMethod(this.options.name,this.build)}handleEditorInit(t){e[t?"addCustomEvent":"removeCustomEvent"](window,"BX.UI.EntityEditorControlFactory:onInitialize",this.onEditorInit)}}function n(t,e="div"){const s=document.createElement(e);return s.innerHTML=t,s.firstElementChild}function i(t){return t.split("_").map(((t,e)=>t.toLowerCase())).join("-")}function o(t,e){return l(e,a(t))}function a(t){const e=r(t),s={};for(const[t,n]of Object.entries(e))if("select"===n.tagName.toLowerCase())for(const e of n.querySelectorAll("option"))e.selected&&(s[t]=e.value);else s[t]=n.value;return s}function l(t,e){const s=r(t);let n=!1;for(const[t,i]of Object.entries(e)){if(null==s[t])continue;const e=s[t];if("select"===e.tagName.toLowerCase())for(const t of e.querySelectorAll("option")){const e=t.value===i;e!==Boolean(t.selected)&&(t.selected=e,n=!0)}else{if(e.value===i)continue;n=!0,e.value=i}}return n}function r(t){const e=t.querySelectorAll("input, select, textarea"),s={};for(const t of e)t.name&&(s[t.name]=t);return s}function u(t,e){let s=t;if(null==e)return s;for(const[t,n]of Object.entries(e))s=s.replace("#"+t+"#",n);return s}s.defaults={name:"yamarket",map:{}};class c extends BX.UI.EntityEditorField{constructor(){super(),this._hasLayout=!1,this.options=null!=this.constructor.defaults?Object.assign({},this.constructor.defaults):{}}getMessage(t,e=null){let s=this.constructor.messages[t]||super.getMessage(t);return null!=e&&(s=u(s,e)),s}clearLayout(){this._hasLayout&&(this.forget(),this._wrapper.innerHTML="",this._hasLayout=!1)}layout(t){if(!this._hasLayout){if(this.ensureWrapperCreated({}),this.adjustWrapper(),!this.isNeedToDisplay())return this.registerLayout(t),void(this._hasLayout=!0);if(this.forget(),this._wrapper.innerHTML="",this.isDragEnabled()&&this._wrapper.appendChild(this.createDragButton()),this.useTitle()){const t=this.getTitle();this._wrapper.appendChild(this.createTitleNode(t))}this.render(this.getValue()),this.isContextMenuEnabled()&&this._wrapper.appendChild(this.createContextMenuButton()),this.isDragEnabled()&&this.initializeDragDropAbilities(),this.registerLayout(t),this._hasLayout=!0}}forget(){}render(t){}useTitle(){return!1}fewElements(t){const e=this.getElementSelector(t);let s;return s=0===e.indexOf("#")?document.querySelectorAll(e):this.el.querySelectorAll(e),s}getElement(t){const e=this.getElementSelector(t);let s;return s=0===e.indexOf("#")?document.querySelector(e):this.el.querySelector(e),s}getElementSelector(t){return this.options[t+"Element"]}}class h{constructor(t){this.onStatusClick=t=>{this.openDialog(),t.preventDefault()},this.options=Object.assign({},this.constructor.defaults,t),this.el=null}clone(){return new this.constructor(this.options)}bind(){this.handleStatusClick(!0)}handleStatusClick(t){const e=this.getElement("status");null!=e&&e[t?"addEventListener":"removeEventListener"]("click",this.onStatusClick)}setup(t){this.el=t,this.bind()}replaceName(t,e){this.options.name=this.options.name.replace(t,e)}build(){return`<div class="yamarket-item-summary">\n\t\t\t${this.buildStatus()}\n\t\t\t<div class="yamarket-item-summary__modal" hidden>\n\t\t\t\t${this.buildForm()}\n\t\t\t</div>\n\t\t</div>`}buildStatus(){const t=this.optionValue(),e=this.getStatus(t);return`<a class="yamarket-item-summary__status" href="#" data-status="${e}">${this.getMessage("SUMMARY_"+e)}</a>`}reflowStatus(){const t=this.formValue(),e=this.getStatus(t),s=this.getElement("status");s.setAttribute("data-status",e),s.textContent=this.getMessage("SUMMARY_"+e)}getStatus(t){throw new Error("not implemented")}buildForm(t=!1){throw new Error("not implemented")}reflowForm(){this.el.querySelector(".yamarket-item-summary__modal").innerHTML=this.buildForm(!0)}optionValue(){throw new Error("not implemented")}formValue(){throw new Error("not implemented")}openDialog(){const t=this.getElement("modal").firstElementChild,e=this.dialogOptions(),s=BX.UI.Dialogs.MessageBox.create(e);s.setMessage(t.cloneNode(!0)),s.setButtons([new BX.UI.SaveButton({events:{click:this.onSaveClick.bind(this,s)}}),new BX.UI.CancelButton({events:{click:this.onCancelClick.bind(this,s)}})]),s.show(),o(this.el,s.popupWindow.contentContainer)}dialogOptions(){return{title:this.getMessage("MODAL_TITLE")}}onSaveClick(t){o(t.popupWindow.contentContainer,this.el)&&this.options.onChange&&this.options.onChange(),this.reflowStatus(),t.close()}onCancelClick(t){t.close()}getMessage(t,e=null){let s=this.options.messages[t]||t;return null!=e&&(s=u(s,e)),s}fewElements(t){const e=this.getElementSelector(t);return this.el.querySelectorAll(e)}getElement(t){const e=this.getElementSelector(t);return this.el.querySelector(e)}getElementSelector(t){return this.options[t+"Element"]}}h.STATUS_READY="READY",h.STATUS_WAIT="WAIT",h.STATUS_OPTIONAL="OPTIONAL",h.STATUS_EMPTY="EMPTY",h.defaults={modalElement:".yamarket-item-summary__modal",statusElement:".yamarket-item-summary__status",inputElement:"input",name:null,messages:{},onChange:null};class d extends h{constructor(...t){super(...t),this.onCopyClick=t=>{this.copyInternal(),t.preventDefault()}}bind(){super.bind(),this.handleCopyClick(!0)}handleCopyClick(t){const e=this.getElement("copy");null!=e&&e[t?"addEventListener":"removeEventListener"]("click",this.onCopyClick)}updateTotal(t){this.options.count=t,this.reflowForm(),this.reflowStatus()}updateCount(t,e){this.options.count=t,this.options.offset=e,this.reflowForm(),this.reflowStatus()}build(){if(0===this.requiredTypes().length)return"&mdash;";const t=this.optionValue("internal");return`<div class="yamarket-item-summary">\n\t\t\t${this.emptyValues(t)?"":this.buildCopyIcon()}\n\t\t\t${this.buildStatus()}\n\t\t\t<div class="yamarket-item-summary__modal" hidden>\n\t\t\t\t${this.buildForm()}\n\t\t\t</div>\n\t\t</div>`}buildCopyIcon(){return`<button class="yamarket-item-summary__copy" type="button" title="${this.getMessage("COPY")}">\n\t\t\t${this.getMessage("COPY")}\n\t\t</button>`}buildForm(t=!1){const e=parseInt(this.options.total)||0,s=new Array(e).fill(null),n=t?this.formValue(!0):this.optionValue(),i=this.requiredTypes();return`<table class="ui-form yamarket-cis-table">\n\t\t\t<thead class="yamarket-cis-table__head">\n\t\t\t\t<td></td>\n\t\t\t\t${i.map((t=>`<td>${this.getMessage("HEAD_"+t)}</td>`)).join("")}\n\t\t\t</thead>\n\t\t\t\n\t\t\t${s.map(((t,e)=>{const s=e<this.options.offset||e>=this.options.count+this.options.offset;return`<tr ${s?"hidden":""}>\n\t\t\t\t\t<td class="yamarket-cis-table__number">\n\t\t\t\t\t\t&numero;${e+1}\n\t\t\t\t\t</td>\n\t\t\t\t\t${i.map((t=>{var o;const a=`ITEMS[${e}][${t}]`,l=null!=(o=n[a])?o:"",r=this.hasMessage("PLACEHOLDER_"+t)?this.getMessage("PLACEHOLDER_"+t):"";return`\n\t\t\t\t\t\t\t<td class="yamarket-cis-table__control type-count--${i.length}">\n\t\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t\t\t\t\t<input class="ui-ctl-element" type="text" name="${this.inputName(a)}" value="${BX.util.htmlspecialchars(l)}" data-name="${a}" placeholder="${r}" ${s?"disabled":""} />\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t`})).join("")}\n\t\t\t\t</tr>`})).join("")}\n\t\t\t${i.includes("CIS")&&null==this.fixedCisType()?`<tr>\n\t\t\t\t\t<td></td>\n\t\t\t\t\t<td class="yamarket-cis-table__type">\n\t\t\t\t\t\t<div class="yamarket-cis-table__type-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("FORMAT")}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="yamarket-cis-table__type-value">\n\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t\t<select class="ui-ctl-element" name="${this.inputName("TYPE")}" data-name="TYPE">\n\t\t\t\t\t\t\t\t\t${["CIS","UIN"].map((t=>`<option value="${t}" ${t===n.TYPE?"selected":""}>${this.getMessage(t)}</option>`)).join("")}\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</td>\n\t\t\t\t</tr>`:""}\n\t\t</table>`}getStatus(t){const[e,s]=this.filledCount(t);let n;return n=e>=this.options.count?h.STATUS_READY:s>=this.options.count?h.STATUS_OPTIONAL:h.STATUS_WAIT,n}emptyValues(t){const e=this.requiredTypes();let s=!0;for(let i=0;i<this.options.total;++i){for(const o of e){var n;if(""!==(null!=(n=t[`ITEMS[${i}][${o}]`])?n:"").trim()){s=!1;break}}if(!s)break}return s}filledCount(t){const e=this.requiredTypes(),s=this.optionalTypes();let n=0,i=0;for(let a=0;a<this.options.total;++a){let l=0,r=0;for(const n of e){var o;""!==(null!=(o=t[`ITEMS[${a}][${n}]`])?o:"").trim()?(++l,++r):s.includes(n)&&++r}l>=e.length?(++n,++i):r>=e.length&&++i}return[n,i]}copyInternal(t=this.el){const e=Object.assign({},this.formValue(!0),this.optionValue("internal"));this.setValues(e,t)&&(this.options.onChange&&this.options.onChange(),this.reflowStatus())}getValues(){return this.formValue()}setValues(t,e=this.el){return l(e,this.makeInputValues(t))}makeInputValues(t){const e={};for(const[s,n]of Object.entries(t))e[this.inputName(s)]=n;return e}inputName(t){const e=t.indexOf("[");let s;return s=e>0?this.options.name+`[${t.substring(0,e)}]`+`${t.substring(e)}`:this.options.name+`[${t}]`,s}formValue(t=!1){const e={};for(const s of this.fewElements("input")){if(!t&&s.disabled)continue;const n=String(s.dataset.name).trim(),i=s.value.trim();""!==n&&(e[n]=i)}return e}optionValue(t=null){const e=null!=t?this.options[t+"Instances"]:this.options.instances,s=this.requiredTypes(),n={},i=this.fixedCisType(),o=this.cisTypes();let a=0;if(!Array.isArray(e))return n;for(const t of e){for(const e of s){var l;let s=(null!=(l=t[e])?l:"").trim(),u=e;var r;if(""===s&&"CIS"===e&&null==i)s=(null!=(r=t.UIN)?r:"").trim(),u="UIN";""!==s&&(n[`ITEMS[${a}][${e}]`]=s,o.includes(u)&&(n.TYPE=u))}++a}return null==i&&null==n.TYPE&&null!=this.options.markingType&&(n.TYPE=this.options.markingType),n}cisTypes(){return["UIN","CIS"]}fixedCisType(){const t=this.options.instanceTypes||[];for(const e of this.cisTypes())if(t.includes(e)||t.includes(e+"_OPTIONAL"))return e;return null}requiredTypes(){const t=(this.options.instanceTypes||[]).slice();let e=!1;for(const s of this.cisTypes()){if(t.includes(s)){e=!0;continue}const n=t.indexOf(s+"_OPTIONAL");-1!==n&&(e=!0,t.splice(n,1),t.unshift(s))}return!e&&this.options.markingGroup&&t.unshift("CIS"),t}optionalTypes(){const t=this.options.instanceTypes||[],e=[];for(const s of this.cisTypes())-1!==t.indexOf(s+"_OPTIONAL")&&e.push(s);return e}dialogOptions(){return{title:this.options.title,minWidth:Math.max(400,Math.min(1200,400*this.requiredTypes().length))}}getMessage(t,e=null){const s="ITEM_CIS_"+t,n=this.options.messages[s];return null!=n?u(n,e):super.getMessage(t,e)}hasMessage(t){return this.getMessage(t)!==t}}d.defaults=Object.assign({},h.defaults,{copyElement:".yamarket-item-summary__copy",inputElement:"input, select",title:"",offset:0,count:0,total:0,markingGroup:!1,markingType:null,instances:[],instanceTypes:[],internalInstances:[]});class m extends h{updateTotal(t){this.options.total=t,this.reflowStatus(),this.reflowForm()}buildForm(t=!1){const e=parseInt(this.options.total)||0,s=t?this.formValue():this.optionValue();return`<div class="ui-form">\n\t\t\t${this.buildFormCodes(e,s)}\n\t\t\t${this.buildFormAdditional(e,s)}\n\t\t</div>`}buildFormCodes(t,e){const s=t>1;return new Array(t).fill(null).map(((t,n)=>{var i;const o=(null==e||null==(i=e.ITEM)?void 0:i[n])||{};let a="",l=`<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("CODE")}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t\t<input class="ui-ctl-element" type="text" name="${this.options.name}[ITEM][${n}][CODE]" value="${BX.util.htmlspecialchars(o.CODE||"")}" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("ACTIVATE_TILL")}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-datetime ui-ctl-w100">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t\t<input class="ui-ctl-element" type="text" name="${this.options.name}[ITEM][${n}][ACTIVATE_TILL]" value="${BX.util.htmlspecialchars(o.ACTIVATE_TILL||"")}" onclick="BX.calendar({node: this, field: this, bTime: false, bHideTime: true})" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>`;return s&&(a=`<div class="yamarket-form-group-title">${this.getMessage("GROUP",{NUMBER:n+1})}</div>`),a+l})).join("")}buildFormAdditional(t,e){const s=t>1;let n="",i=`<div class="ui-form-row">\n\t\t\t<div class="ui-form-label">\n\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("SLIP")}</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-content">\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t<textarea class="ui-entity-editor-field-textarea" name="${this.options.name}[SLIP]" rows="5" required>${BX.util.htmlspecialchars(e.SLIP||"")}</textarea>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>`;return s&&(n=`<div class="yamarket-form-group-title">${this.getMessage("ADDITIONAL")}</div>`),n+i}getStatus(t){const e=this.filterFilledItems(t.ITEM).length>=this.options.total,s=null!=t.SLIP&&""!==t.SLIP.trim();return e&&s?h.STATUS_READY:h.STATUS_WAIT}filterFilledItems(t){const e=[];for(const s of t)null!=s.CODE&&""!==s.CODE.trim()&&null!=s.ACTIVATE_TILL&&""!==s.ACTIVATE_TILL.trim()&&e.push(s);return e}optionValue(){const t=Array.isArray(this.options.items)?this.options.items:[];let e="";for(const s of t)if(null!=s.SLIP&&""!==s.SLIP){e=s.SLIP;break}return{ITEM:t,SLIP:e}}formValue(){const t=a(this.el),e=class{static toTree(t,e=null){const s={};for(const n in t){if(!t.hasOwnProperty(n))continue;const i=this.keyRelative(n,e);if(null==i)continue;const o=this.valueKeyChain(i);this.setValueByKeyChain(s,o,t[n])}return s}static keyRelative(t,e){return null==e?t:0!==t.indexOf(e)?null:t.replace(e,"")}static valueKeyChain(t){const e=t.split("["),s=[];for(const t of e){if(""===t&&0===s.length)continue;const e=t.replace(/]$/,"");s.push(e)}return s}static setValueByKeyChain(t,e,s){const n=e.pop();let i=t;for(let t=0;t<e.length;++t){const s=e[t],o=t+1===e.length?n:e[t+1];null==i[s]&&(i[s]=/^\d+$/.test(o)?[]:{}),i=i[s]}i[n]=s}}.toTree(t,this.options.name);return Object.assign({ITEM:[],SLIP:""},e)}getMessage(t,e=null){const s="ITEM_DIGITAL_"+t,n=this.options.messages[s];return null!=n?u(n,e):super.getMessage(t,e)}}m.defaults=Object.assign({},h.defaults,{items:[],total:0});class p{constructor(t){this.options=Object.assign({},this.constructor.defaults,t),this._wires=[]}destroy(){this.unbind(),this.forgetWires(),this.options={}}clone(){const t=new this.constructor(this.options);t.el=this.el.cloneNode(!0);for(const[e,s]of Object.entries(this._wires))t.wire(e,s.clone());return t.setupWires(),t.bind(),t}bind(){}unbind(){}getMessage(t){return this.options.messages[t]||t}getTitle(){return this.el.querySelector('[data-entity="NAME"]').textContent.trim()}id(){return this.getInputValue("ID")}render(t,e){var s;const i=Object.keys(e.COLUMNS),o=e.ITEMS[t.BASKET_KEY];i.unshift("INDEX"),this.forgetWires(),this.el=n(`<tr class="${(null==t||null==(s=t.PARTIAL_COUNT)?void 0:s.CURRENT)>0?"is--partial":""}">\n\t\t\t${i.map((e=>this.renderColumn(t,o,e))).join("")}\n\t\t\t${this.renderActions()}\n\t\t</tr>`,"tbody"),this.setupWires(),this.bind()}mount(t){t.appendChild(this.el)}replaceName(t){const e=this.options.name;for(const[s,n]of Object.entries(r(this.el)))n.name=s.replace(e,t);for(const[,s]of Object.entries(this._wires))s.replaceName(e,t);this.options.name=t}renderColumn(t,e,s){const n="column"+s.split("_").map((t=>t.substr(0,1).toUpperCase()+t.substr(1).toLowerCase())).join("");return n in this?this[n](t,e,s):this.columnDefault(t,e,s)}enableUp(t=!0){}enableDown(t=!0){}columnIndex(t,e,s){return`<td class="for--${i(s)}">\n\t\t\t${this.indexHidden(t,e)}\n\t\t\t${this.valueFormatted(t,e,s)}\n\t\t</td>`}indexHidden(t,e){const s=this.value(t,e,"IDENTIFIERS_INITIAL_COUNT");return[`<input type="hidden" name="${this.getName("ID")}" value="${this.value(t,e,"ID")}" />`,`<input type="hidden" name="${this.getName("INITIAL_BOX")}" value="${this.value(t,e,"INITIAL_BOX")}" />`,s>0?`<input type="hidden" name="${this.getName("IDENTIFIERS")}[INITIAL_COUNT]" value="${s}" />`:""].join("")}columnCis(t,e,s){const n=new d({messages:this.options.messages,name:this.getName("IDENTIFIERS"),title:this.basketValue(e,"NAME"),markingType:this.basketValue(e,"MARKING_TYPE"),markingGroup:!!this.basketValue(e,"MARKING_GROUP"),instanceTypes:this.basketValue(e,"INSTANCE_TYPES"),count:+this.value(t,e,"COUNT"),offset:+this.value(t,e,"OFFSET"),total:+this.basketValue(e,"COUNT"),instances:this.basketValue(e,"INSTANCES"),internalInstances:this.basketValue(e,"INTERNAL_INSTANCES"),onChange:()=>{this.fire("cisUpdate"),this.options.onChange()}});return this.wire(s,n),`<td class="for--${i(s)}" data-wire="${s}">${n.build()}</td>`}cis(){return this._wires.CIS}updateCisCount(){var t;null==(t=this.cis())||t.updateCount(this.getCount(),this.getOffset())}columnDigital(t,e,s){const n=new m({messages:this.options.messages,name:this.getName("DIGITAL"),total:this.value(t,e,"COUNT"),items:this.value(t,e,"DIGITAL"),onChange:this.options.onChange});return this.wire(s,n),`<td class="for--${i(s)}" data-wire="${s}">${n.build()}</td>`}columnSubsidy(t,e,s){const n=this.value(t,e,"PROMOS");let o=this.valueFormatted(t,e,s);return null!=n&&Array.isArray(n)&&(o+=n.map((t=>`<div>${t}</div>`)).join("")),`<td class="for--${i(s)}">${o}</td>`}columnCount(t,e,s){var n,o;const a=this.value(t,e,s),l=parseInt(a)||"",r=parseInt(this.value(t,e,"OFFSET"))||0,u=null==t||null==(n=t.PARTIAL_COUNT)?void 0:n.CURRENT,c=null==t||null==(o=t.PARTIAL_COUNT)?void 0:o.TOTAL;return`<td class="for--${i(s)}">\n\t\t\t<input type="hidden" name="${this.getName("INITIAL_COUNT")}" value="${l}" />\n\t\t\t<input type="hidden" name="${this.getName("COUNT")}" value="${l}" />\n\t\t\t<input type="hidden" name="${this.getName("OFFSET")}" value="${r}" />\n\t\t\t<input type="hidden" name="${this.getName("PARTIAL_CURRENT")}" value="${u||""}" />\n\t\t\t<input type="hidden" name="${this.getName("PARTIAL_TOTAL")}" value="${c||""}" />\n\t\t\t<span data-entity="COUNT_TEXT">${this.valueFormatted(t,e,s)} ${this.getMessage("ITEM_UNIT")}</span>\n\t\t\t<span data-entity="PARTIAL_TEXT">${this.partialText(u,c)}</span>\n\t\t</td>`}setCount(t){const e=this.getInput("COUNT"),s=this.el.querySelector('[data-entity="COUNT_TEXT"]');e.value=t,s.textContent=`${t} ${this.getMessage("ITEM_UNIT")}`}getCount(){return parseInt(this.getInputValue("COUNT"))||0}setInitialCount(t){this.getInput("INITIAL_COUNT").value=t}getInitialCount(){return parseInt(this.getInputValue("INITIAL_COUNT"))||0}setOffset(t){this.getInput("OFFSET").value=t}getOffset(){return parseInt(this.getInputValue("OFFSET"))||0}resetPart(){this.el.classList.remove("is--partial"),this.getInput("PARTIAL_CURRENT").value="",this.getInput("PARTIAL_TOTAL").value="",this.el.querySelector('[data-entity="PARTIAL_TEXT"]').textContent=""}setPart(t,e){this.el.classList.add("is--partial"),this.getInput("PARTIAL_CURRENT").value=t+1,this.getInput("PARTIAL_TOTAL").value=e,this.el.querySelector('[data-entity="PARTIAL_TEXT"]').textContent=this.partialText(+t+1,e)}partialText(t,e){return t>0?`${this.getMessage("ITEM_PART")} ${t}/${e}`:""}isPart(){return parseInt(this.getInputValue("PARTIAL_CURRENT"))>0}isFinalPart(){const t=parseInt(this.getInputValue("PARTIAL_CURRENT"))||0,e=parseInt(this.getInputValue("PARTIAL_TOTAL"))||0;return t>0&&t===e}columnDefault(t,e,s){return`<td class="for--${i(s)}" data-entity="${s}">${this.valueFormatted(t,e,s)}</td>`}renderActions(){return""}wire(t,e){this._wires[t]=e}forgetWires(){this._wires={}}setupWires(){for(const[t,e]of Object.entries(this._wires)){const s=this.el.querySelector(`[data-wire="${t}"]`).firstElementChild;s&&e.setup(s)}}callWires(t,e=[]){for(const[,s]of Object.entries(this._wires)){if("function"!=typeof s[t])return;s[t].apply(s,e)}}valueFormatted(t,e,s){const n=s+"_FORMATTED";let i="";return null!=t[s]?i=t[s]:null!=e[n]?i=e[n]:null!=e[s]&&(i=e[s]),""!==i?i:"&mdash;"}basketValue(t,e){return t[e]}value(t,e,s){return null!=t[s]?t[s]:this.basketValue(e,s)}getName(t){return this.options.name+"["+t+"]"}hasAction(t){return-1!==this.options.actions.indexOf(t)}fire(t,e={}){this.el.dispatchEvent(new CustomEvent("yamarketBasketItemAction",{detail:Object.assign({item:this,action:t},e),bubbles:!0}))}getInputValue(t){const e=this.getInput(t);let s;return null==e?null:(s="checkbox"===e.type?e.checked?e.value:null:e.value,s)}getInput(t){const e=this.getName(t);return this.el.querySelector(`input[name="${e}"]`)}}p.defaults={messages:{},name:null,actions:[],onChange:null};class g extends p{constructor(...t){super(...t),this.onCountChange=t=>{const e=parseInt(t.target.value);isNaN(e)||this.callWires("updateTotal",[e])},this.onMoveClick=t=>{this.fire("move",{direction:t.currentTarget.dataset.action})},this.onMoreClick=()=>{const t=this.moreDropdown();this.renewMoreActions(t),t.popupWindow.show()}}destroy(){this.destroyMoreDropdown(),super.destroy()}bind(){this.handleInputChange(!0),this.handleMoveClick(!0),this.handleMoreClick(!0)}unbind(){this.handleInputChange(!1),this.handleMoveClick(!1),this.handleMoreClick(!1)}handleInputChange(t){this.options.onChange&&this.el.querySelectorAll("input").forEach((e=>{e.name===this.getName("COUNT")&&e[t?"addEventListener":"removeEventListener"]("change",this.onCountChange),e[t?"addEventListener":"removeEventListener"]("change",this.options.onChange)}))}handleMoveClick(t){var e,s;this.hasAction(y.ACTION_BOX)&&(null==(e=this.el.querySelector('[data-action="up"]'))||e[t?"addEventListener":"removeEventListener"]("click",this.onMoveClick),null==(s=this.el.querySelector('[data-action="down"]'))||s[t?"addEventListener":"removeEventListener"]("click",this.onMoveClick))}handleMoreClick(t){var e;this.hasAction(y.ACTION_ITEM)&&(null==(e=this.el.querySelector('[data-action="more"]'))||e[t?"addEventListener":"removeEventListener"]("click",this.onMoreClick))}disableInput(t){this.el.querySelectorAll("input").forEach((e=>{e.name!==this.getName("DELETE")&&(e.readonly=t,e.classList.contains("ui-ctl-element")&&e.parentElement.classList.toggle("ui-ctl-disabled",t))}))}replaceName(t){this.destroyMoreDropdown(),super.replaceName(t)}getCountDiff(){const t=this.getInputValue("DELETE"),e=parseInt(this.getInputValue("INITIAL_COUNT")),s=parseInt(this.getInputValue("COUNT"));let n;return n=t?e:e-s,n}enableUp(t=!0){this.el.querySelector('[data-action="up"]').disabled=!t}enableDown(t=!0){this.el.querySelector('[data-action="down"]').disabled=!t}columnIndex(t,e,s){return this.hasAction(y.ACTION_BOX)?`<td class="for--${i(s)}">\x3c!--\n\t\t\t--\x3e${this.indexHidden(t,e)}\x3c!--\n\t\t\t--\x3e<button class="yamarket-icon-action" type="button" data-action="down">\n\t\t\t\t<svg class="yamarket-icon-action__draw" viewBox="0 0 11.314 16.657">\n\t\t\t\t\t<path d="M4.657 0h2v12.828l3.242-3.242L11.314 11l-5.657 5.657L0 11l1.414-1.414 3.243 3.242V0Z" fill="currentColor"/>\n\t\t\t\t</svg>\n\t\t\t</button>\x3c!--\n\t\t\t--\x3e<button class="yamarket-icon-action" type="button" data-action="up">\n\t\t\t\t<svg class="yamarket-icon-action__draw" viewBox="0 0 11.314 17.416">\n\t\t\t\t\t<path d="M11.314 5.67 9.896 7.081l-3.255-3.27-.014 13.605-2-.002.014-13.568-3.23 3.215L0 5.644 5.67 0l5.644 5.67Z" fill="currentColor"/>\n\t\t\t\t</svg>\n\t\t\t</button>\x3c!--\n\t\t--\x3e</td>`:super.columnIndex(t,e,s)}columnCount(t,e,s){var n,o;if(!this.hasAction(y.ACTION_ITEM))return super.columnCount(t,e,s);const a=this.value(t,e,s),l=parseFloat(a)||"",r=null==t||null==(n=t.PARTIAL_COUNT)?void 0:n.CURRENT,u=null==t||null==(o=t.PARTIAL_COUNT)?void 0:o.TOTAL;return`<td class="for--${i(s)}">\n\t\t\t<input type="hidden" name="${this.getName("INITIAL_COUNT")}" value="${l}" />\n\t\t\t<input type="hidden" name="${this.getName("OFFSET")}" value="${parseInt(this.value(t,e,"OFFSET"))||0}" />\n\t\t\t<input type="hidden" name="${this.getName("PARTIAL_CURRENT")}" value="${r||""}" />\n\t\t\t<input type="hidden" name="${this.getName("PARTIAL_TOTAL")}" value="${u||""}" />\n\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-textbox ui-ctl-w100" data-entity="COUNT">\n\t\t\t\t<input\n\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\ttype="number"\n\t\t\t\t\tname="${this.getName("COUNT")}"\n\t\t\t\t\tvalue="${l}"\n\t\t\t\t\tmin="1"\n\t\t\t\t\tmax="${l}"\n\t\t\t\t\tstep="1"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<span data-entity="PARTIAL_TEXT">${this.partialText(r,u)}</span>\n\t\t</td>`}setCount(t){this.getInput("COUNT").value=t}setInitialCount(t){this.getInput("COUNT").max=t,super.setInitialCount(t)}renderActions(){return this.hasAction(y.ACTION_ITEM)?`<td class="for--delete">\n\t\t\t<input type="hidden" name="${this.getName("DELETE")}" value="" />\n\t\t\t<button class="yamarket-icon-action" type="button" data-action="more">\n\t\t\t\t<svg class="yamarket-icon-action__draw" viewBox="0 0 14 3.5">\n\t\t\t\t\t<path d="M3.5 1.75C3.5 2.71653 2.7165 3.5 1.75 3.5C0.783501 3.5 0 2.71653 0 1.75C0 0.783475 0.783501 0 1.75 0C2.7165 0 3.5 0.783475 3.5 1.75L3.5 1.75Z" fill="currentColor" />\n\t\t\t\t\t<path d="M8.75 1.75C8.75 2.71653 7.96653 3.5 7 3.5C6.03347 3.5 5.25 2.71653 5.25 1.75C5.25 0.783475 6.03347 0 7 0C7.96653 0 8.75 0.783475 8.75 1.75L8.75 1.75Z" fill="currentColor" />\n\t\t\t\t\t<path d="M12.25 3.5C13.2165 3.5 14 2.71653 14 1.75C14 0.783475 13.2165 0 12.25 0C11.2835 0 10.5 0.783475 10.5 1.75C10.5 2.71653 11.2835 3.5 12.25 3.5L12.25 3.5Z" fill="currentColor" />\n\t\t\t\t</svg>\n\t\t\t</button>\n\t\t</td>`:""}destroyMoreDropdown(){null!=this._moreDropdown&&(BX.PopupMenu.destroy(`${this.options.name}-more`),this._moreDropdown=null)}moreDropdown(){return null==this._moreDropdown&&(this._moreDropdown=BX.PopupMenu.create(`${this.options.name}-more`,this.el.querySelector('[data-action="more"]'),[])),this._moreDropdown}renewMoreActions(t){const e=t.getMenuItems().map((t=>t.id));for(const s of e)t.removeMenuItem(s,{destroyEmptyPopup:!1});for(const e of this.moreActions(t))t.addMenuItem(e)}moreActions(t){return this.moreActionsForSplit(t).concat(this.moreActionsForDelete(t))}moreActionsForDelete(t){if(!this.hasAction(y.ACTION_ITEM)||this.isPart())return[];const e=[];return"Y"===this.getInput("DELETE").value?e.push({onclick:()=>{t.popupWindow.close(),this.markDeleted(!1)},text:this.getMessage("ITEM_CANCEL_DELETE")}):e.push({onclick:()=>{t.popupWindow.close(),this.markDeleted(!0)},text:this.getMessage("ITEM_DELETE")}),e}moreActionsForSplit(t){if(!this.hasAction(y.ACTION_BOX)||"Y"===this.getInputValue("DELETE"))return[];const e=[];return this.getInput("PARTIAL_CURRENT").value>0?e.push({onclick:()=>{t.popupWindow.close(),this.fire("cancelSplit")},text:this.getMessage("ITEM_CANCEL_SPLIT")}):e.push({onclick:()=>{t.popupWindow.close(),this.fire("split")},text:this.getMessage("ITEM_SPLIT")}),e}markDeleted(t=!0){this.getInput("DELETE").value=t?"Y":"",this.el.classList[t?"add":"remove"]("is--deleted"),this.disableInput(t),this.options.onChange()}}g.defaults=Object.assign({},p.defaults);class I{constructor(t){this.options=Object.assign({},this.constructor.defaults,t),this.items=[],this.nextIndex=0}destroy(){for(const t of this.items)t.destroy()}getMessage(t){return this.options.messages[t]||t}sameBasketItems(t){const e=[];for(const s of this.items)t.id()===s.id()&&e.push(s);return e}countChanges(){const t=[];for(const e of this.items){if(!(e instanceof g))continue;const s=e.getCountDiff();s>0&&t.push({name:e.getTitle(),diff:s})}return t}render(t,e){this.renderSelf(),this.renewItems(t.length).forEach(((s,n)=>{s.render(t[n],e),s.mount(this.el)}))}mount(t){t.after(this.el)}renderSelf(){this.el=n("<tbody></tbody>","table")}renewItems(t){return this.destroyItems(),this.createItems(t)}destroyItems(){for(const t of this.items)t.destroy();this.items=[]}createItems(t){this.items=[];for(let e=0;e<t;++e)this.items.push(this.createItem(e));return this.nextIndex=this.items.length,this.items}createItem(t){const e={messages:this.options.messages,name:`${this.options.name}[${t}]`,actions:this.options.actions,onChange:this.options.onChange};return this.options.mode===BX.UI.EntityEditorMode.edit?new g(e):new p(e)}moveItem(t,e=null){const s=this.sameBasketItems(t);if(s.length>0){const n=s[0];return null!=e?(n.setCount(n.getCount()+e),n.setInitialCount(n.getInitialCount()+e)):(n.setCount(n.getCount()+t.getCount()),n.setInitialCount(n.getInitialCount()+t.getInitialCount())),t.destroy(),n}return this.items.push(t),t.replaceName(`${this.options.name}[${this.nextIndex}]`),t.mount(this.el),null!=e&&(t.setCount(e),t.setInitialCount(e)),++this.nextIndex,t}detachItem(t){const e=this.items.indexOf(t);-1!==e&&(this.items.splice(e,1),t.el.remove())}}I.defaults={messages:{},mode:null,name:null,title:null,actions:[],onChange:null};class f{constructor(t){this.options=Object.assign({},this.constructor.defaults,t)}destroy(){this.basket.destroy()}getMessage(t){return this.options.messages[t]||t}onlyForPart(){let t=!1;for(const e of this.basket.items)if(e.isPart()){t=!0;break}return t}title(){return this.el.querySelector(".yamarket-basket-box__title").textContent.trim()}render(t,e){this.renderSelf(t,e),this.renderBasket(t,e)}renderSelf(t,e){this.el=n(`<tbody>\n\t\t\t<tr>\n\t\t\t\t<td class="yamarket-basket-box" colspan="${this.columnCount(e)}">\n\t\t\t\t\t<span class="yamarket-basket-box__title">\n\t\t\t\t\t\t${this.getMessage("BOX")}\n\t\t\t\t\t\t&numero;${t.NUMBER}\n\t\t\t\t\t</span>\n\t\t\t\t\t${this.buildActions(t)}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t</tbody>`,"table")}hideSelf(){this.el.hidden=!0}renderBasket(t,e){var s;this.basket=new I(this.basketOptions()),this.basket.render(null!=(s=t.ITEMS)?s:[],e)}basketOptions(){return{name:this.options.name+"[ITEMS]",mode:BX.UI.EntityEditorMode.view,messages:this.options.messages,actions:this.options.actions,onChange:this.options.onChange}}columnCount(t){return Object.keys(t.COLUMNS).length+1}buildActions(t){return""}detach(){this.el.remove(),this.basket.el.remove()}mount(t,e=null){var s;null!=e?(null!=(s=e.nextElementSibling)?s:e).after(this.el):t.querySelector("table").appendChild(this.el);this.basket.mount(this.el)}updateNumber(t){this.el.querySelector(".yamarket-basket-box__title").innerHTML=`${this.getMessage("BOX")} &numero;${t}`}getName(t){return this.options.name+"["+t+"]"}}f.defaults={name:null,messages:{},actions:[],onChange:null};class v{constructor(t={}){this.options=Object.assign({},v.defaults,t)}onSaveClick(t,e,s){const n=a(t.popupWindow.contentContainer),i=parseInt(n.COUNT)||0;i<=0?s():(t.close(),e(["new"===n.BOX?null:this.options.items[n.BOX],i]))}onCancelClick(t,e){t.close(),e()}open(){return new Promise(((t,e)=>{const s=this.dialogOptions(),n=BX.UI.Dialogs.MessageBox.create(s);n.setMessage(this.buildForm()),n.setButtons([new BX.UI.SaveButton({events:{click:this.onSaveClick.bind(this,n,t,e)}}),new BX.UI.CancelButton({events:{click:this.onCancelClick.bind(this,n,e)}})]),n.show()}))}dialogOptions(){return{title:this.getMessage("ITEM_MOVE_TITLE")}}buildForm(){let t=!1;return`<div class="ui-form-row">\n\t\t\t<div class="ui-form-label">\n\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("ITEM_MOVE_COUNT")}</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-content">\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t<input class="ui-ctl-element" type="number" name="COUNT" value="${parseInt(this.options.count)||0}" min="1" max="${parseInt(this.options.count)||0}" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="ui-form-row">\n\t\t\t<div class="ui-form-label">\n\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("ITEM_MOVE_BOX")}</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-content">\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t<select class="ui-ctl-element" name="BOX">\n\t\t\t\t\t\t${this.options.items.map(((e,s)=>{if(e===this.options.current)return"";const n=e===this.options.selected;return n&&(t=!0),`<option value="${s}" ${n?"selected":""}>${e.title()}</option>`}))}\n\t\t\t\t\t\t<option value="new" ${t?"":"selected"}>${this.getMessage("ITEM_MOVE_BOX_NEW")}</option>\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>`}getMessage(t){return this.options.messages[t]||t}}v.defaults={count:0,current:null,selected:null,items:[],messages:{}};class C{constructor(t={}){this.options=Object.assign({},this.constructor.defaults,t)}onSaveClick(t,e,s){const n=a(t.popupWindow.contentContainer),i=parseInt(n.COUNT)||0;t.close(),i>=2?e(i):s()}onCancelClick(t,e){t.close(),e()}open(){return new Promise(((t,e)=>{const s=this.dialogOptions(),n=BX.UI.Dialogs.MessageBox.create(s);n.setMessage(this.buildForm()),n.setButtons([new BX.UI.SaveButton({events:{click:this.onSaveClick.bind(this,n,t,e)}}),new BX.UI.CancelButton({events:{click:this.onCancelClick.bind(this,n,e)}})]),n.show()}))}dialogOptions(){return{title:this.getMessage("ITEM_SPLIT_TITLE")}}buildForm(){return`<div class="ui-form-row">\n\t\t\t<div class="ui-form-label">\n\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("ITEM_SPLIT_COUNT")}</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-content">\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t<input class="ui-ctl-element" type="number" name="COUNT" value="2" min="2" max="99" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>`}getMessage(t){return this.options.messages[t]||t}}C.defaults={messages:{}};class T{constructor(t={}){this.options=Object.assign({},this.constructor.defaults,t)}open(){return new Promise(((t,e)=>{const s=BX.UI.Dialogs.MessageBox.create();s.setMessage(this.getMessage("BOX_DELETE_PART_BY_MERGE")),s.setButtons([new BX.UI.SaveButton({events:{click:()=>{s.close(),t()}}}),new BX.UI.CancelButton({events:{click:()=>{s.close(),e()}}})]),s.show()}))}getMessage(t){return this.options.messages[t]||t}}T.defaults={messages:{}};class E extends f{constructor(...t){super(...t),this.onDeleteClick=t=>{this.el.dispatchEvent(new CustomEvent("yamarketBoxDelete",{detail:{item:this},bubbles:!0})),t.preventDefault()}}destroy(){this.unbind(),super.destroy()}unbind(){null!=this.el&&this.handleDeleteClick(!1)}handleDeleteClick(t){this.el.querySelector('[data-action="DELETE"]')[t?"addEventListener":"removeEventListener"]("click",this.onDeleteClick)}render(t,e){super.render(t,e),this.handleDeleteClick(!0)}columnCount(t){return super.columnCount(t)+1}enableDelete(t){const e=this.el.querySelector('[data-action="DELETE"]');e.disabled=!t,e.hidden=!t}buildActions(t){return`<button\n\t\t\tclass="yamarket-icon-action"\n\t\t\ttype="button"\n\t\t\ttitle="${this.getMessage("BOX_DELETE")}"\n\t\t\tdata-action="DELETE"\n\t\t>\n\t\t\t<svg class="yamarket-icon-action__draw" viewBox="0 0 14 15">\n\t\t\t\t<path d="M13.126 1.406v.933a.47.47 0 0 1-.47.469H.47A.47.47 0 0 1 0 2.338v-.932c0-.259.21-.47.47-.47h3.512L4.258.39A.76.76 0 0 1 4.884 0h3.353c.262.014.5.16.63.389l.277.548h3.516a.47.47 0 0 1 .466.47zM.939 3.75h11.25l-.626 9.932A1.424 1.424 0 0 1 10.16 15H2.963a1.424 1.424 0 0 1-1.4-1.318L.94 3.75z" fill="currentColor" fill-rule="evenodd"/>\n\t\t\t</svg>\n\t\t</button>`}basketOptions(){return Object.assign(super.basketOptions(),{mode:BX.UI.EntityEditorMode.edit})}}class b{constructor(t){this.nextIndex=0,this.options=Object.assign({},this.constructor.defaults,t)}destroy(){this.destroyItems()}getMessage(t){return this.options.messages[t]||t}movableBox(t,e){return e?this.nextMovableBox(t):this.previousMovableBox(t)}previousMovableBox(t){let e,s;for(const n of this.items){if(n===t){s=e;break}n.onlyForPart()||(e=n)}return s}nextMovableBox(t){let e,s=!1;for(const n of this.items){if(s&&!n.onlyForPart()){e=n;break}n===t&&(s=!0)}return e}render(t,e,s){const n=[];let i=0;this.destroyItems();for(const o of t){const t=this.createItem(i,s);t.render(o,e),n.push(t),++i}this.items=n,this.nextIndex=i}mount(t){this.anchor=t;for(const e of this.items)e.mount(t)}addItem(t,e){var s;const n=this.items.length+1,i=this.createItem(this.nextIndex,e),o=null==(s=this.items[this.items.length-1])?void 0:s.el;return i.render({NUMBER:n},t),i.mount(this.anchor,o),this.items.push(i),++this.nextIndex,i}destroyItems(){if(null!=this.items){for(const t of this.items)t.destroy();this.items=[]}}createItem(t,e){const s={name:this.options.name+`[${t}]`,messages:this.options.messages,actions:this.options.actions,onChange:this.options.onChange};return e===BX.UI.EntityEditorMode.edit?new E(s):new f(s)}deleteItem(t){const e=this.items.indexOf(t);-1!==e&&(this.items.splice(e,1),t.detach(),t.destroy())}refresh(t=null){null!=t&&this.refreshBasketOffset(t),this.refreshBoxDelete(),this.refreshBasketMove(),this.refreshNumber()}refreshNumber(){let t=1;for(const e of this.items)e.updateNumber(t),++t}basketItemBox(t){let e;for(const s of this.items){for(const n of s.basket.items)if(n===t){e=s;break}if(null!=e)break}return e}refreshBoxDelete(){const t=this.items.length>1,e=-1!==this.options.actions.indexOf(y.ACTION_BOX);for(const s of this.items)t||e?s instanceof E&&s.enableDelete(t):s.hideSelf()}refreshBasketMove(){if(-1!==this.options.actions.indexOf(y.ACTION_BOX))for(const t of this.items){const e=t.onlyForPart(),s=!e&&null!=this.previousMovableBox(t),n=!e&&null!=this.nextMovableBox(t);for(const i of t.basket.items)i.enableUp(s),i.enableDown(n||!e&&(t.basket.items.length>1||i.getCount()>1))}}sameBasketItems(t){let e=[];for(const s of this.items)e=e.concat(s.basket.sameBasketItems(t));return e}refreshBasketOffset(t){const e=this.sameBasketItems(t);let s=0;for(const t of e)t.setOffset(s),t.isPart()&&!t.isFinalPart()||(s+=t.getInitialCount()),t.updateCisCount()}}b.defaults={name:null,actions:[],messages:{},onChange:null};class y extends c{constructor(...t){super(...t),this.onChange=()=>{this._mode!==BX.UI.EntityEditorMode.edit&&(this.hasAction(y.ACTION_CIS)||this.hasAction(y.ACTION_DIGITAL))&&(this._mode=BX.UI.EntityEditorMode.edit,this._editor.showToolPanel(),this._editor.registerActiveControl(this)),this._changeHandler()},this.onBoxDelete=t=>{var e;const s=t.detail.item;if(s.onlyForPart())return void new T({messages:y.messages}).open().then((()=>{for(const t of s.basket.items)this.cancelSplitBasketItem(t)}));const n=null!=(e=this.boxCollection.previousMovableBox(s))?e:this.boxCollection.nextMovableBox(s);if(null!=n){for(const t of s.basket.items)this.moveBasketItem(t,n);this.boxCollection.deleteItem(s),this.boxCollection.refresh(),this.onChange()}},this.onBasketItemAction=t=>{const e=t.detail.item,s=t.detail.action;"cisUpdate"===s?this.copyCis(e):"move"===s?this.startMoveBasketItem(e,"down"===t.detail.direction):"split"===s?this.startSplitBasketItem(e):"cancelSplit"===s&&this.cancelSplitBasketItem(e)}}static create(t,e){const s=new y;return s.initialize(t,e),s}bind(){this.handleBoxDelete(!0),this.handleBasketItemAction(!0)}unbind(){null!=this.el&&(this.handleBoxDelete(!1),this.handleBasketItemAction(!1))}handleBoxDelete(t){this.el[t?"addEventListener":"removeEventListener"]("yamarketBoxDelete",this.onBoxDelete)}handleBasketItemAction(t){this.el[t?"addEventListener":"removeEventListener"]("yamarketBasketItemAction",this.onBasketItemAction)}countChanges(){let t=[];for(const e of this.boxCollection.items)t=t.concat(e.basket.countChanges());return t}copyCis(t){var e;const s=this.boxCollection.sameBasketItems(t),n=null==(e=t.cis())?void 0:e.getValues();if(!(s.length<=1||null==n))for(const e of s){var i;e!==t&&(null==(i=e.cis())||i.setValues(n))}}startMoveBasketItem(t,e){const s=this.boxCollection.basketItemBox(t),n=this.boxCollection.movableBox(s,e),i=t.getCount();if(t.getCount()<=1){const e=this.moveBasketItem(t,null!=n?n:this.addBox());this.afterMoveBasketItem(e)}else new v({count:i,current:s,selected:n,items:this.boxCollection.items,messages:y.messages}).open().then((e=>{let s,[n,o]=e;null==n&&(n=this.addBox()),o<i?(s=this.moveBasketItem(t,n,o,!0),t.setCount(t.getCount()-o),t.setInitialCount(t.getInitialCount()-o)):s=this.moveBasketItem(t,n),this.afterMoveBasketItem(s)}))}moveBasketItem(t,e,s=null,n=!1){if(n)t=t.clone();else{const e=this.boxCollection.basketItemBox(t);e.basket.detachItem(t),0===e.basket.items.length&&this.boxCollection.deleteItem(e)}return e.basket.moveItem(t,s)}afterMoveBasketItem(t){this.boxCollection.refresh(t),this.onChange()}startSplitBasketItem(t){new C({messages:y.messages}).open().then((e=>this.splitBasketItem(t,e)))}splitBasketItem(t,e){const[s,n]=this.removeBasketItemSiblings(t),i=(t.getCount()||1)+s,o=(t.getInitialCount()||1)+n;for(let s=0;s<i;++s)for(let n=0;n<e;++n){const a=0===s&&0===n,l=this.addBox(),r=this.moveBasketItem(t,l,1,!a);r.setPart(n,e),0===s&&r.setInitialCount(o-i+1)}this.afterMoveBasketItem(t)}removeBasketItemSiblings(t){const e=this.boxCollection.sameBasketItems(t);let s=0,n=0;for(const i of e){if(i===t)continue;const e=this.boxCollection.basketItemBox(i);s+=i.getCount()||0,n+=i.getInitialCount()||0,e.basket.detachItem(i),0===e.basket.items.length&&this.boxCollection.deleteItem(e)}return[s,n]}cancelSplitBasketItem(t){const e=this.boxCollection.sameBasketItems(t),[s,n]=this.countSiblings(e);let i=null;for(const t of e){if(null==i){var o;const e=this.boxCollection.basketItemBox(t),a=null!=(o=this.boxCollection.previousMovableBox(e))?o:this.boxCollection.nextMovableBox(e);t.resetPart(),t.setCount(s),t.setInitialCount(n),t.setOffset(0),t.updateCisCount(),null!=a&&this.moveBasketItem(t,a),i=t;continue}const e=this.boxCollection.basketItemBox(t);e.basket.detachItem(t),0===e.basket.items.length&&this.boxCollection.deleteItem(e)}i&&this.afterMoveBasketItem(i)}countSiblings(t){let e=0,s=0;for(const n of t)n.isPart()&&!n.isFinalPart()||(e+=n.getCount()||0,s+=n.getInitialCount()||0);return[e,s]}addBox(){return this.boxCollection.addItem(this.payloadBasket,this._mode)}render(t){this.unbind(),this.options.actions=t.ACTIONS,this.payloadBasket=t.BASKET,this.renderSelf(t.BOX.length),this.renderBoxes(t.BOX),this._wrapper.appendChild(this.el),this.bind()}renderSelf(t){this.el=n(`<div class="yamarket-basket">\n\t\t\t<input type="hidden" name="BOX_INITIAL_COUNT" value="${t}" />\n\t\t\t<div class="yamarket-basket-table-viewport">\n\t\t\t\t<table class="yamarket-basket-table">\n\t\t\t\t\t${this.renderHeader()}\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t\t${this.renderSummary()}\n\t\t</div>`)}renderHeader(){return`<thead>\n\t\t\t<tr>\n\t\t\t\t<td class="for--index">&numero;</td>\n\t\t\t\t${Object.keys(this.payloadBasket.COLUMNS).map((t=>`<td class="for--${i(t)}">${this.columnTitle(t)}</td>`)).join("")}\n\t\t\t\t${this.isInEditMode()&&this.hasAction(y.ACTION_ITEM)?'<td class="for--delete">&nbsp;</td>':""}\n\t\t\t</tr>\n\t\t</thead>`}columnTitle(t){const e="HEADER_"+t,s=this.getMessage(e);return s!==e?s:this.payloadBasket.COLUMNS[t]}renderSummary(){return 0===this.payloadBasket.SUMMARY.length?"":`<div class="yamarket-basket-summary">\n\t\t\t${this.payloadBasket.SUMMARY.map((t=>`<div class="yamarket-basket-summary__row">\n\t\t\t\t\t\t<div class="yamarket-basket-summary__label">${t.NAME}:</div>\n\t\t\t\t\t\t<div class="yamarket-basket-summary__value">${t.VALUE}</div>\n\t\t\t\t\t</div>`)).join("")}\n\t\t</div>`}renderBoxes(t){var e;null==(e=this.boxCollection)||e.destroy(),this.boxCollection=new b({name:this.options.name,messages:y.messages,actions:this.options.actions,onChange:this.onChange}),this.boxCollection.render(t,this.payloadBasket,this._mode),this.boxCollection.refreshBasketMove(),this.boxCollection.refreshBoxDelete(),this.boxCollection.mount(this.el)}hasAction(t){return-1!==this.options.actions.indexOf(t)}}y.ACTION_BOX="box",y.ACTION_ITEM="item",y.ACTION_CIS="cis",y.ACTION_DIGITAL="digital",y.messages={},y.defaults={name:"BOX",actions:[]};class k extends c{static create(t,e){const s=new k;return s.initialize(t,e),s}validate(t){const e=this._parent.getChildById("BOX");if(null==e)return;const s=e.countChanges();return 0!==s.length?(this.resetValues(),this.showDialog(s,t)):void 0}resetValues(){l(this.el,{[`${this.options.name}[ALLOW_REMOVE]`]:""})}showDialog(t,e){return new Promise((s=>{const n=BX.UI.Dialogs.MessageBox.create({title:this.getMessage("MODAL_TITLE"),message:this.dialogBody(t)});n.setButtons([new BX.UI.SendButton({events:{click:this.onSendClick.bind(this,n,s)}}),new BX.UI.CancelButton({events:{click:this.onCancelClick.bind(this,n,e,s)}})]),n.show()}))}dialogBody(t){return`\n\t\t\t${this.options.reasons.length>0?`\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("REASON")}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t${this.reasonControl()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`:""}\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">${this.getMessage("PRODUCTS")}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t${this.productsControl(t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui-alert ui-alert-warning">${this.getMessage("FORM_INTRO")}</div>\n\t\t`}reasonControl(){return`<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t<select class="ui-ctl-element" name="${this.options.name}[REASON]">\n\t\t\t\t${this.options.reasons.map((t=>`<option value="${t.ID}">${t.VALUE}</option>`)).join("")}\n\t\t\t</select>\n\t\t</div>`}productsControl(t){return t.map((t=>this.getMessage("ITEM_CHANGE",{NAME:t.name,COUNT:t.diff}))).join("<hr />")}onSendClick(t,e){l(this.el,Object.assign(a(t.popupWindow.contentContainer),{[`${this.options.name}[ALLOW_REMOVE]`]:"Y"})),t.close(),e()}onCancelClick(t,e,s){const n=BX.UI.EntityValidationError.create({field:this});this.resetValues(),e.addError(n),t.close(),s()}render(t){this.extendOptions(t),this.el=n(`<div class="ui-helper-hidden">\n\t\t\t<input type="hidden" name="${this.options.name}[REASON]" value="" />\n\t\t\t<input type="hidden" name="${this.options.name}[ALLOW_REMOVE]" value="" />\n\t\t</div>`),this._wrapper.appendChild(this.el)}extendOptions(t){this.options=Object.assign(this.options,{reasons:t.ITEMS_CHANGE_REASON})}}k.messages={},k.defaults={name:"BASKET_CONFIRM",reasons:[]};class A extends c{constructor(...t){super(...t),this.onActivityEnd=t=>{this.isMatchActivity(t)&&this._editor.reload()}}static create(t,e){const s=new A;return s.initialize(t,e),s}useTitle(){return!0}bind(){this.handleActivityEnd(!0)}unbind(){this.handleActivityEnd(!1)}handleActivityEnd(t){if(null==this._activityType)return;const e=this.getElement("broadcast");BX[t?"addCustomEvent":"removeCustomEvent"](e,"yamarketActivitySubmitEnd",this.onActivityEnd)}isMatchActivity(t){return null!=t&&(t===this._activityType||0===t.indexOf(this._activityType+(-1===this._activityType.indexOf("|")?"|":".")))}forget(){this.el&&this.unbind()}render(t){var e;const s=this.build(t);this._activityType=null==t||null==(e=t.ACTIVITY_ACTION)?void 0:e.TYPE,this.el=n(s),this.bind(),this._wrapper.appendChild(this.el)}build(t){const e=t.ACTIVITY_ACTION;return`<div class="ui-entity-editor-content-block">\n\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t${BX.util.htmlspecialchars(t.VALUE)}\n\t\t\t\t${e?this.buildActivity(e,t):""}\n\t\t\t</div>\n\t\t</div>`}buildActivity(t,e){const s=t.TEXT!==e.NAME?t.TEXT:this.getMessage("ACTIVITY_APPLY");return`<small>\n\t\t\t<a href="#" onclick='${this.makeActivityMethod(t)}; return false'>${s}</a>\n\t\t</small>`}makeActivityMethod(t){let e;if(null!=t.MENU){const s=t.MENU.map((t=>({text:t.TEXT,onclick:t.METHOD})));e=`BX.PopupMenu.show("${t.TYPE}", this, ${JSON.stringify(s)}, { angle: { offset: 50 } })`}else e=t.METHOD;return e}}A.messages={},A.defaults={broadcastElement:"#YAMARKET_ORDER_VIEW"};class _ extends c{constructor(...t){super(...t),this.onDocumentClick=t=>{const e=t.currentTarget.dataset.type,s=this.getItem(e),n=this.buildDocumentUrl(e);this.createDialog(n,s).Show(),t.preventDefault()}}static create(t,e){const s=new _;return s.initialize(t,e),s}bindDocumentsClick(){this._wrapper.querySelectorAll(".yamarket-print__link").forEach((t=>{t.addEventListener("click",this.onDocumentClick)}))}getItem(t){let e;for(const s of this.options.items)if(s.TYPE===t){e=s;break}return e}buildDocumentUrl(t){const e=this.options.url;return e+(-1===e.indexOf("?")?"?":"&")+"type="+t}createDialog(t,e){return new BX.YandexMarket.PrintDialog({title:e.DIALOG_TITLE||e.TITLE,content_url:t,width:e.WIDTH||this.options.width,height:e.HEIGHT||this.options.height,buttons:[BX.YandexMarket.PrintDialog.btnSave,BX.YandexMarket.PrintDialog.btnCancel]})}render(t){this.extendOptions(t),this.renderIntro(),this.renderDocuments(t.ITEMS),this.bindDocumentsClick()}extendOptions(t){this.options=Object.assign(this.options,{url:t.URL,items:t.ITEMS})}renderIntro(){const t=n(`<p class="yamarket-print__intro">${this.getMessage("INTRO")}</p>`);this._wrapper.appendChild(t)}renderDocuments(t){if(!Array.isArray(t))return;const e=n(`<ul class="yamarket-print__documents">\n\t\t\t${t.map((t=>`<li class="yamarket-print__document">\n\t\t\t\t<a class="yamarket-print__link" href="#" data-type="${t.TYPE}">${t.TITLE}</a>\n\t\t\t</li>`)).join("")}\n\t\t</ul>`);this._wrapper.appendChild(e)}}_.messages={},_.defaults={url:null,width:400,height:300,items:[]};class M extends c{static create(t,e){const s=new M;return s.initialize(t,e),s}render(t){if(!Array.isArray(t))return;const e=t.map((t=>`<div class="ui-alert ui-alert-${t.type}">${t.text}</div>`)).join("");this._wrapper.insertAdjacentHTML("beforeend",e)}}M.defaults={};new s({map:{notification:M,box:y,basket_confirm:k,property:A,print:_}}).register();(new class{constructor(){this.onEditorInit=(t,e)=>{"yamarket_order_tab"===e.id&&(this.overrideEditor(t),this.overrideEditorAjax(t),this.restoreOriginDefault())}}start(){this.storeOriginDefault(),this.handleEditorInit()}handleEditorInit(){BX.addCustomEvent(window,"BX.UI.EntityEditor:onInit",this.onEditorInit)}storeOriginDefault(){var t,e,s;this._originDefault=null==(t=BX)||null==(e=t.UI)||null==(s=e.EntityEditor)?void 0:s.getDefault()}restoreOriginDefault(){null!=this._originDefault&&setTimeout((()=>{var t,e,s;null==(t=BX)||null==(e=t.UI)||null==(s=e.EntityEditor)||s.setDefault(this._originDefault)}))}overrideEditor(t){const e=t.createAjaxForm;Object.assign(t,{validate:this.editorValidate.bind(this,t),createAjaxForm:this.editorCreateAjaxForm.bind(this,t,e)})}editorValidate(t,e){const s=BX.UI.EntityAsyncValidator.create();for(const n of t._activeControls)s.addResult(n.validate(e));return this._userFieldManager&&s.addResult(this._userFieldManager.validate(e)),Promise.resolve(s.validate())}editorCreateAjaxForm(t,e,s,n){const i=e.call(t,s,n);return this.overrideAjaxForm(i),i}overrideEditorAjax(t){this.overrideAjaxForm(t._ajaxForm)}overrideAjaxForm(t){var e,s;t&&null!=(e=BX)&&null!=(s=e.UI)&&s.ComponentAjax&&t instanceof BX.UI.ComponentAjax&&Object.assign(t,{doSubmit:this.ajaxFormDoSubmit})}ajaxFormDoSubmit(t){const e=this._elementNode?BX.ajax.prepareForm(this._elementNode):{data:BX.clone(this._formData),filesCount:0};if(BX.type.isPlainObject(t.data))for(const s in t.data)t.data.hasOwnProperty(s)&&(e.data[s]=t.data[s]);const s=e.filesCount>0?this.makeFormData(e):e;BX.ajax.runComponentAction(this._className,this._actionName,{mode:"ajax",signedParameters:this._signedParameters,data:s,getParameters:this._getParameters}).then((t=>{const e=BX.prop.getFunction(this._callbacks,"onSuccess",null);e&&(BX.onCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmit",[t.data.ENTITY_DATA,t]),e(t.data))})).catch((t=>{const e=BX.prop.getFunction(this._callbacks,"onFailure",null);if(e){for(var s=[],n=t.errors,i=0,o=n.length;i<o;i++)s.push(n[i].message);BX.onCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmitFailure",[t.errors]),e({ERRORS:s})}}))}}).start(),t.Notification=M,t.BasketConfirm=k,t.Box=y,t.Property=A,t.Print=_}(this.BX.YandexMarket.UI.EntityEditor=this.BX.YandexMarket.UI.EntityEditor||{});
//# sourceMappingURL=script.js.map
